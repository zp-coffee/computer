# 计算机网络体系架构

## 计算机网络概述

### 概述

*   **计算机网络**是一个将**分散的，具有独立功能**的计算机系统，通过**通信设备**与**线路**连接起来，由**功能完善的软件**实现**资源共享**和**信息传递**的系统

*   **客户机**是客户访问网络的出入口
*   **服务器**是提供服务，存储信息的设备
*   **中继器和桥接器**通常是用于局域网的物理层和数据链路层的联网设备
*   目前局域网接入广域网主要是通过**路由器**这种互联设备来实现的

*   ARPAnet是最早的计算机网络，是因特网(Internet)的前身



### 计算机网络的组成

*   **从组成部分上看：**
    *   硬件
        *   主机(端系统)，通信链路(双绞线，光纤)，交换设备(路由器，交换机)，通信处理机(网卡)
    *   软件
        *   各种实现资源共享的软件和方便用户使用的各种工具软件(网络操作系统，邮件收发程序，FTP程序，聊天软件)，软件多属于应用层
    *   协议
        *   计算机网络的核心，协议规定了网络传输数据时所遵循的规范
*   **从工作方式上看：**
    *   边缘部分(计算机实体，身体各部分)
        *   所有连接到因特网上，供用户直接使用的主机组成，用来进行通信和资源共享
    *   核心部分(计算机之间的连接器，大脑)
        *   大量的网络和连接这些网络的路由器组成，为边缘部分提供连通性和交换服务

*   **从逻辑功能组成上看：**
    *   通信子网(传输介质，通信设备，协议)
        *   各种传输介质，通信设备和相应的网络协议，使网络具有数据传输，交换，控制和存储的能力，实现联网计算机之间的数据通信
        *   网桥，交换机，路由器
        *   对应OSI参考模型下三层：物理层，数据链路层，网络层
    *   资源子网(资源共享，软件，设备)
        *   实现资源共享功能的设备及其软件的集合，向网络用户提供共享其他计算机上的硬件资源，软件资源和数据资源的服务
        *   资源子网主要由计算机系统，终端，联网外部设备，各种软件资源和信息资源等组成
        *   计算机软件



### 计算机网络的功能

*   **数据通信**
    *   计算机网络的**最基本，最重要**的功能，用来实现联网计算机之间各种信息的传输，并将分散在不同地理位置的计算机联系起来，进行统一的调配，控制和管理
*   **资源共享**
    *   软件共享，硬件共享，数据共享，使计算机网络中的资源互通有无，分工协作，极大地提高硬件资源，软件资源，数据资源的利用率
*   **分布式处理**
    *   将处理的某个复杂任务分配给网络中的其他计算机系统，从而利用空闲计算机资源来提高整个系统的利用率
*   **提高可靠性**
    *   计算机网络中的各台计算机可以通过网络互为替代机
*   **负载均衡**
    *   将工作任务均衡地分配给计算机网络中的各台计算机



### 计算机网络的分类

*   **按分布范围：**
    *   广域网(WAN)
        *   提供长距离通信，是因特网的核心部分，连接广域网的各结点交换机的链路一般都是高速链路，具有较大的通信容量，采用交换技术
    *   城域网(MAN)
        *   采用以太网技术
    *   局域网(LAN)
        *   使用广播技术，局域网工作在数据链路层
    *   个人区域网(PAN)
        *   指在个人工作的地方将消费电子设备用**无线技术**连接起来的网络，也称无线个人局域网



*   **按传输技术：**
    *   广播式网络
        *   局域网，广域网中的无线，卫星通信网络
    *   点对点网络
    *   是否采用**分组存储转发**和**路由选择机制**是点对点式网络与广播式网络的重要区别，广域网基本都属于点对点网络



*   **按拓扑结构：**

    *   网络拓扑结构是指网中结点(主机，路由器)与通信线路(网线)之间的几何关系表示的网络结构，主要指**通信子网**的拓扑结构

    

    *   总线形网络(多用于局域网)

        *   优点：建网容易，增/减结点方便，节省线路

        *   缺点：重负载时通信效率不高，总线任意一处对故障敏感

            ![img](/Users/coffeeboy/Desktop/考研/assets/70.gif)

    *   星形网络(多用于局域网)

        *   优点：便于集中控制和管理

        *   缺点：成本高，中央设备对故障敏感

            ![img](/Users/coffeeboy/Desktop/考研/assets/70-20231011165038047.gif)

    *   环形网络(多用于局域网)

        *   令牌环局域网，环中信号是单向传输的，多用于局域网

            ![img](/Users/coffeeboy/Desktop/考研/assets/70-20231011165200205.gif)

    *   网状网络(多用于广域网)

        *   有规则型和非规则型

        *   优点：可靠性高

        *   缺点：控制复杂，线路成本高

            ![img](/Users/coffeeboy/Desktop/考研/assets/70-20231011165324810.gif)



*   **按使用者分类：**
    *   公用网
        *   电信公司出资建造的大型网络
    *   专用网
        *   某个部门为了满足本单位特殊业务建造的网络，比如铁路，电力，军队等部门的专用网



*   **按交换技术分类：**
    *   交换技术是指**各台主机之间，各通信设备之间或主机与通信设备之间**为**交换信息所采用的数据格式和交换装置**的方式
    *   电路交换网络
        *   在源结点和目的结点之间建立一条专用的线路，会独占资源，比如电话通信
        *   优点：数据直接传送，时延小
        *   缺点：线路利用率低，不能充分利用线路容量，不便于进行差错控制
    *   报文交换网络
        *   将用户数据封装成报文，可以单独选择到达目的结点的路径，采用存储，转发机制，不独占资源
        *   优点：
            *   充分地利用线路容量
            *   实现不同链路之间不同数据传输速率的转换
            *   实现格式转换
            *   实现一对多，多对一的访问
            *   实现差错控制
        *   缺点：
            *   增大了资源开销
            *   增加了缓冲时延
            *   需要额外的控制机制来保证多个报文的顺序不乱序
            *   缓冲区难以管理
    *   分组交换网络
        *   将数据分成固定长度的数据块，采用报文交换网络的传输方式进行传输
        *   优点：
            *   报文网络的优点
            *   缓冲易于管理
            *   包的平均时延更小
            *   网络占用的平均缓冲区更少
            *   更易于标准化
            *   更适合应用



*   **按传输介质分类：**
    *   无线网络
        *   蓝牙，微波，无线电
    *   有线网络
        *   双绞线网络
        *   同轴电缆网络



### 计算机网络的性能指标

*   **带宽：**网络的通信线路所能传送数据的能力，单位比特/秒 (b/s)
*   **时延：**数据从网络的一端传送到另一端所需的总时间
    *   发送时延
        *   数据从发送端到线路上的时间：发送时延=分组长度/信道宽度
    *   传播时延
        *   数据在线路上传输的时间：传播时延=信道长度/电磁波在信道上的传播速率，传播时延取决于传播介质以及收发双方的距离
    *   处理时延
        *   数据到达结点进行处理的时间
    *   排队时延
        *   数据进入路由器后在输入队列排队等待处理的时间
*   **时延带宽积：**发送端发送的第一个比特即将到达终点时，发送端已经发出了多少个比特
    *   时延带宽积=传播时延*信道带宽
*   **往返时延：**从发送端发出一个短分组，到发送端接收到接受端到确认的总时间
*   **吞吐量：**单位时间内通过某个网络的数据量
*   **速率：**连接到计算机网络上的主机在**数字信道**上传送数据的速率，也称**数据传输速率，数据率，比特率**，通常把最高数据传输速率称为带宽
*   **信道利用率：**某一信道有百分之多少时间是有数据通过的，信道利用率=有数据通过时间/总时间



*   总时延=发送时延+传播时延+处理时延+排队时延
*   对于高速链路，提高的仅是数据发送速率而非比特在链路上的传输速率，提高数据的发送速率只是为了减少数据的发送时延

![assets-20231011193027388](/Users/coffeeboy/Desktop/考研/assets/image-20231011193027388.png)



## 计算机网络体系结构与参考模型

### 计算机网络分层结构

*   **目的：**为了降低协议设计和调试过程的复杂性，为了便于对网络进行研究，实现和维护，促进标准化工作，所以对计算机网络的体系结构进行分层建模
*   **体系结构：**计算机网络的各层及其协议的集合
*   **分层的基本原则：**
    *   每层都实现一种相对独立的功能，降低大系统的复杂度——**(独立的功能)**
    *   各层之间界面自然清晰，易于理解，相互交流尽可能少——**(界面清晰)**
    *   各层功能的精确定义独立于具体的实现方法，可以采用最合适的技术来实现——**(实现方法独立)**
    *   保持下层对上层的独立性，上层单向使用下层提供的服务——**(上下层独立)**
    *   整个分层结构应能促进标准化工作——**(每层都促进标准化工作)**
*   第n层中的活动元素通常称为第n层实体，**实体：**任何可发送或接收信息的硬件或软件进程，通常是一个特定的软件模块
*   不同机器上的同一层称为**对等层**，同一层的实体称为**对等实体**
*   每层的报文分为2个部分：服务数据单元SDU，协议控制信息PCI，SDU+PCI=PDU(协议数据单元)
*   每一层传送的数据单元的名称，大小，含义都不同：
    *   物理层的PDU称为**比特**
    *   数据链路层的PDU称为**帧**
    *   网络层的PDU称为**分组**
    *   传输层的PDU称为**报文段**
*   **层次结构的含义：**
    *   上层要使用下层的服务来完成本层的功能，再向更上层提供服务
    *   最底层只提供服务，是整个层次结构的基础，最高层向用户提供服务
    *   上层只能通过相邻层之间的接口来使用下层的服务，下层提供的服务的实现细节对上层透明
    *   两台主机通信时，对等层在逻辑上有一条直接信道，能不经过下层直接将信息发送到对方



### 协议，接口，服务

*   **协议：**
    *   **协议：**规则的集合
    *   **网络协议：**为进行网络中的数据交换而建立的规则，标准或约定，控制**对等实体**进行通信的规则的集合，简称协议
    *   协议由**语法，语义，同步**三部分组成：
        *   **语法：**规定了传输数据的格式（格式）
        *   **语义：**规定了所要完成的功能，即需要发出何种控制信息，完成何种动作及做出何种应答（数据）
        *   **同步：**规定了执行各种操作的条件，时序关系，即事件实现顺序的详细说明（顺序）
    *   一个完整的协议应具有**线路管理，差错控制，数据转换**的功能
*   **接口：**
    *   **接口：**是同一结点内**相邻两层间**的交换信息的连接点，是一个系统内部的规定
    *   同一结点相邻两层的实体通过**服务访问点SAP**进行交互
*   **服务：**
    *   **服务：**下层为紧邻的上层提供的功能调用
    *   上层使用下层所提供的服务时必须与下层交换一些命令，这些命令在OSI模型中称为**服务原语**
    *   OSI参考模型将原语分为四类：
        *   请求（requset）：由上层发往下层，请求完成某项工作
        *   响应（response）：由上层发往下层，作为对指示的响应
        *   指示（indication）：由下层发往上层，指示上层做某件事情
        *   证实（confirmation）：由下层发往上层，作为对请求的证实
    *   有应答服务包括全部4类原语，无应答服务只包含请求和指示
    *   只有本层协议的实现才能保证向上一层提供服务
    *   并非在一层内完成的所有功能都叫做服务，只有能够被上一层实体看得见的才称为服务
    *   计算机网络提供的服务按以下三种方式分类：
        *   **面向连接服务和无连接服务**
            *   面向连接服务：通信前双方必须建立连接，分配相应的资源(如缓冲区)，传输结束后释放连接和所占用的资源，可以分为连接建立，数据传输，连接放三个阶段，比如TCP
            *   无连接服务：通信前双方不需要建立连接，发送数据时直接发送，把每个带有目的地址的包传送线路上，这是一种不可靠的服务，比如IP，UDP
        *   **可靠服务和不可靠服务**
            *   可靠服务：指网络具有纠错，检错，应答机制，能保证数据正确，可靠地传送到目的地
            *   不可靠服务：指网络只是尽量正确，可靠地传送，而不能保证数据正确，可靠地传送到目的地，是一种尽力而为的服务
        *   **有应答服务和无应答服务**
            *   有应答服务：指接收方在收到数据后向发送方给出相应的回答，比如文件传输服务
            *   无应答服务：指接收方收到数据后不自动给出应答，若需要应答由高层实现，比如WWW服务



### ISO/OSI参考模型和TCP/IP模型

#### OSI参考模型

*   **OSI参考模型：**ISO提出的网络体系结构模型，称为**开放系统互连参考模型(OSI/RM)**
*   OSI一共有7层：物理层，数据链路层，网络层，传输层，会话层，表示层，应用层
*   低三层：物理层，数据链路层，网络层统称为**通信子网**，为了联网而附加的通信设备，完成数据的传输功能
*   高三层：会话层，表示层，应用层统称为**资源子网**，相当于计算机系统，完成数据的处理
*   传输层承上启下
*   **分别说明各层的功能：**
    *   **物理层：**（底层设备）
        *   传输单位：比特
        *   功能：在物理媒体上为数据端设备透明地传输原始比特流
        *   物理层主要定义**数据终端设备(DTE)**和**数据通信设备(DCE)**的物理与逻辑连接方法
        *   物理层的接口标准很多，比如：EIA-232C，EIA/TIA，RS-449，CCITT的X.21
        *   物理层的主要研究内容：
            *   通信链路与通信结点的连接需要一些电路接口，物理层规定了这些接口的一些参数，如：机械形状，尺寸，交换电路的数量和排列
            *   物理层也规定了通信链路上传输的信号的意义和电气特征
        *   传输信号所利用的物理媒体，如双绞线，光缆，无线信道并不在物理层协议之内
    *   **数据链路层：**（点到点的线路）
        *   传输单位：帧
        *   功能：将网络层传来的IP数据报组装**成帧（成帧），差错控制，流量控制，传输管理**
            *   差错控制：检测数据传输中的错误，将错误信息丢弃
            *   流量控制：协调两个结点之间的速率
        *   广播式网络在数据链路层还需要处理**如何控制对共享信道的访问**，数据链路层中的子层：介质访问子层就是来处理这个问题
        *   典型的数据链路层协议：SDLC，HDLC，PPP，STP和帧中断
    *   **网络层：**（主机到主机）
        *   传输单位：数据报(分组)
        *   功能：通信子网的运行控制，把网络层的协议数据单元(分组)从源端传到目的端，为分组交换网上的不同主机提供通信服务，主要问题是对分组进行**路由选择，实现差错控制，流量控制，拥塞控制，网际互联**
        *   拥塞控制：缓解一个结点来不及接收分组而要丢弃大量分组使网络处于拥塞的情况
        *   因特网由大量异构网络通过路由器相互连接起来，主要网络协议为**无连接的网际协议和许多路由选择协议**，也称网际层或IP层
        *   网络层的协议：IP，IPX，ICMP，IGMP，ARP，RARP，OSPF
    *   **传输层：**（端到端的线路）
        *   传输单位：报文段(TCP)或用户数据报(UDP)
        *   功能：负责**主机中两个进程之间的通信**，为端到端连接提供可靠的传输服务，为端到端连接提供**差错控制，流量控制，应答，分组排序，服务质量，数据传输管理等服务，复用和分用的功能**
        *   复用：指多个应用层进程可同时使用下面传输层的服务
        *   分用：指传输层把收到的信息分别交付给上面应用层中相应的进程
        *   数据链路层提供的是点到点的通信，传输层提供的是端到端的通信
        *   点到点指的是**主机到主机之间的通信**，一个点指一个硬件地址或IP地址，网络中参与通信的主机是通过硬件地址或IP地址标识
        *   端到端指的是运行在**不同主机内的两个进程之间的通信**，一个进程由一个端口来标识
        *   传输层的协议：TCP，UDP
    *   **会话层：**（管理会话，同步）
        *   会话层允许不同主机上的各个进程之间进行会话
        *   会话层利用传输层提供的端到端的服务，向表示层提供他的增值服务，这种服务主要为**表示层实体或用户进程**建立连接并在连接上有序地传输数据，也称**建立同步**（SYN）
        *   会话层负责管理主机间的会话进程，包括建立，管理及终止进程间的会话
        *   会话层可以使用校验点使通信会话在通信失效时从校验点继续恢复通信，实现数据同步
    *   **表示层：**（表示方式转换）
        *   表示层主要处理两个通信系统中交换信息的表示方式
        *   采用抽象的标准方法定义数据结构，标准的编码形式，数据压缩
        *   ，加密和解密的方式来使不同表示方法的数据和信息之间能够进行交换
    *   **应用层：**（交互界面）
        *   OSI模型的最高层，是用户与网络的界面
        *   应用层为特定类型的网络应用提供访问OSI参考模型环境的手段
        *   应用层的协议：文件传送的FTP，电子邮件的SMTP，万维网的HTTP



#### TCP/IP参考模型

*   ARPA在研究APRAnet时提出了**TCP/IP**模型
*   TCP/IP模型一共有四层：网络接口层，网际层，传输层，应用层
*   **网络接口层：**（与物理网络的接口）
    *   功能类似于OSI的**物理层和数据链路层**
    *   作用：从主机或结点接收IP分组，并将他们发送到指定的物理网络中
*   **网际层：**（主机到主机）
    *   功能类似于OSI的网络层
    *   网际层定义了标准的分组格式和协议，即IP，采用的IP协议是IPv4，下一版是IPv6
*   **传输层：**（应用到应用 或 进程到进程）
    *   功能类似于OSI中的传输层
    *   作用：使得发送端和目的端主机上的对等实体进行会话
    *   传输层主要使用以下两种协议：
        *   传输控制协议（TCP）：面向连接，数据传输的单位是报文段，能够提供可靠的交付
        *   用户数据报协议（UDP）：无连接，数据传输的单位是用户数据报，不能提供可靠的交付
*   **应用层：**（用户到用户）
    *   包含所有的高层协议，比如虚拟终端协议（Telnet），文件传输协议（FTP），域名解析服务（DNS），电子邮件协议（SMTP），超文本传输协议（HTTP）



#### OSI和TCP/IP模型的比较

*   **相似之处：**
    *   都采取分层的体系结构，将庞大且复杂的问题划分为若干较容易处理的，范围较小的问题
    *   都是基于独立的协议栈的概念
    *   都可以解决异构网络的互联，实现世界上不同厂家生产的计算机之间的通信
*   **差别：**
    *   OSI精确地定义了三个主要概念：服务，协议，接口，而TCP/IP在这三个概念上没有明确的区分
    *   OSI通用性良好，TCP/IP不会出现协议不能匹配模型的情况，但该模型不适合于其他任何非TCP/IP的协议栈
    *   对于多种异构网的互联问题，OSI在网络层中划分出一个子层来完成类似于TCP/IP模型中的IP的功能，TCP/IP将网际协议（IP）作为一个单独的重要层次
    *   OSI在**网络层支持无连接和面向连接的通信，但在传输层仅有面向连接的通信**，TCP/IP在**网际层仅有一种无连接的通信模式，但传输层支持无连接和面向连接两种模式**



### 习题

*   对网络模型进行分层的目标：
    *   提供标准语言
    *   定义标准界面
    *   增加功能之间的独立性
*   将用户数据分成一个个数据块传输的优点：
    *   减少延迟时间
    *   提供错误控制效率
    *   使多个应用更公平地使用共享通信介质
*   ISO设计出了OSI/RM参考模型，但是实际使用的是TCP/IP
*   **数据链路层**在不可靠的物理介质上提供可靠的传输
    *   作用有：物理寻址，成帧，流量控制，差错校验，数据重发
    *   功能有：链路连接的建立，拆除，分离，帧界定，帧同步，差错检测
*   **网络层**实现路由选择，流量控制，差错控制，拥塞控制，网际互联
*   **传输层**实现应答，分组排序，流量控制，差错控制，应答
*   **会话层**实现会话管理，同步，恢复通信
*   **表示层**实现数据解密和加密，压缩，格式转换
*   **网络层和表示层**为上层提交的数据加上首部，**数据链路层**为上层提交的数据加上首部和尾部
*   **数据链路层**在分组上增加源和目的物理地址，还有控制信息
*   **传输层**负责增加相应源和目的端口信息
*   **网络层**只增加PCI(协议控制信息)
*   **OSI**在网络层支持无连接和面向连接的通信，在传输层仅支持面向连接的通信
*   **TCP/IP**在网际层仅支持无连接的通信，在传输层支持无连接和面向连接的通信
*   只有**传输层及其以上各层**的通信才能称为**端到端**，**数据链路层及其以上各层**都有流量控制和差错控制功能
*   因特网应用到网络协议为采用**分组交换技术的TCP/IP协议**
*   服务访问点（SAP）是一个层次系统的上下层之间进行通信的接口
    *   物理层的SAP为**网卡接口**
    *   数据链路层的SAP为**MAC地址（网卡地址）**
    *   网络层的SAP为**IP地址（网络地址）**
    *   传输层的SAP为**端口号**
    *   应用层的SAP为**用户界面**
*   **集线器**是一个多端口的中继器，工作在**物理层**
*   **以太网交换机**是一个多端口的网桥，工作在**数据链路层**
*   **路由器**是**网络层**设备
*   数据链路层，网络层，传输层都具有**流量控制和差错控制**功能
    *   数据链路层是相邻结点之间的流量控制，网络层是整个网络中的流量控制，传输层是端到端的流量控制
*   **传输速率**是指主机在数字信道上发送数据的速率
*   **带宽**是指在计算机网络中数字信道所能传送的“最高数据传输速率”，常用来表示网络的通信线路传送数据的能力
*   **传播速率**时是指电磁波在信道中传播的速率



![image-20231018163425895](/Users/coffeeboy/Desktop/考研/assets/image-20231018163425895-7618069.png)



# 物理层

## 通信基础

### 物理层通信相关概念

*   **数据：**指传送信息的实体
*   **信号：**数据的电气或电磁表现，是数据在传输过程中的存在形式
*   **数据和信号的表现形式有：**
    *   连续变化的数据(信号)：模拟数据/模拟信号
    *   取值为有限个离散数值的数据(信号)：数字数据/数字信号
*   **数据的传输方式：**
    *   串行传输
    *   并行传输

*   **码元：**用来表示不同进制的一个固定时长的信号波形，代表不同离散数值的基本波形
*   **码元宽度：**码元波形的时长
*   1个码元可以携带多个bit

*   一个数据通信系统包含：信源，信道，信宿
    *   **信源：**产生和发送数据的源头
    *   **信道：**信号的传输媒介
    *   **信宿：**接受数据的终点
*   **信道**按照**传输信号形式**分为：
    *   模拟信道
    *   数字信道
*   **信道**按照**传输介质**分为：
    *   无线信道
    *   有线信道
*   **信道**按**信号**分为：
    *   基带信号：将数字信号1和0直接用两种不同的**电压**表示，送到数字信道上传输(基带传输)
        *   数字基带传输在信道中直接传输数字信号，且传输媒体的整个带宽都被基带信号占用，能双向地传输信息
        *   用数字信号对特定频率的载波进行调制，在**模拟信道上**传输调制后的**数字信号**，这种传输方式称为**频带传输**
    *   带宽信号：将基带信号进行调制后形成**频分复用模拟信号**，送到模拟信道上传输(宽带传输)
        *   借助频带传输，将信道进行**频分复用**，划分为2条互不相关的子信道，分别在子信道上同时进行频带传输，这就是**带宽传输**
*   **信道**的**极限容量**是信道的最高码元传输速率/极限信息传输速率



*   从通信双方信息的**交互方式**来看分为：
    *   单向通信
    *   半双工通信
    *   全双工通信



*   **速率/数据率：**指数据传输速率，表示单位时间内传输的数据量，用码元传输速率/信息传输速率来表示
    *   码元传输速率：也叫波特率，单位时间内传输码元的个数(脉冲个数/信号变化的次数)，单位Baud
    *   信息传输速率：也叫信息速率，比特率，单位时间内传输的二进制码元个数(比特数)，单位b/s



*   **带宽：**信号所具有的频带宽度，也用来表示网络中的通信线路所能传输数据的能力



### 奈氏定理和香农定理

*   **奈氏定理：**在理想低通(没有噪声，带宽有限)的信道中，为了避免码间串扰，**极限码元传输速率**为2W波特
    *   W：理想低通信道的带宽
    *   V：每个码元离散电平的数目
    *   理想低通信道下的极限数据传输速率 = $2Wlog_2V$
*   由奈氏定理得出：
    *   任何通道中码元传输速率数有上限的，如果超过，则会出现**码间串扰问题**
    *   信道的带宽越高，就可使用越高的速率进行码元的有效传输
    *   奈氏准则限制了**码元传输速率**但是没有限制**信息传输速率**，即**一个码元可以携带多少比特**没有规定



*   下面给出信息传输速率的极限：
*   **香农定理：**在带宽受限且有高斯白噪声干扰的信道下不产生误差的极限数据传输速率
    *   信道的极限数据传输速率 = $Wlog_2(1+S/N)$
    *   W：信道的带宽
    *   S/N：信噪比，信号与噪声的平均功率之比
    *   还有一种信噪比采用dB为单位：信噪比 = $10log_{10}(S/N)$
*   由香农定理得出：
    *   信道的带宽或信噪比越大，信息的极限传输速率越高
    *   只要信息的传输速率低于极限传输速率，就能找懂一种方式实现无差错的传输
    *   香农定理得出的是极限传输速率，实际能达到的传输速率要低不少



### 编码与调制

*   **编码：**将数据转变为数字信号(结果为数字信号)
*   **调制：**将数据转变为模拟信号(结果为模拟信号)



*   **数字数据编码为数字信号：**(编码，用数字发送器)
    *   在基本不改变数字数据信号频率的情况下，直接传输数字信号，一共有6种编码规则
    *   **归零编码(RZ)：**
        *   用高电平代表1，低电平代表0(或者相反)，每个时钟周期的中间均跳变到低电平(归零)
        *   优点：接受方根据归零调整时钟，提供了自同步机制
        *   缺点：归零需要占用一部分带宽，传输效率受到影响
    *   **非归零编码(NRZ)：**
        *   用高电平代表1，低电平代表0(或者相反)，一个周期全部用来表示数据(不归零)
        *   缺点：无法传递时钟信号，若想传输高速同步信号，则需要时钟线
    *   **反向非归零编码(NRZI)：**
        *   用信号的翻转代表0，信号保持不变代表1
        *   优点：翻转信号本身作为一种通知机制，能传输时钟信号，也不损失系统带宽
        *   应用：USB2.0
    *   **曼切斯特编码：**
        *   将一个码元分成两个相等的间隔，前一个间隔为高电平而后一个间隔为低电平代表1，0相反(或者互换)
        *   优点：有时钟信号，可用于同步，宽带是原始基带宽度的2倍
        *   应用：以太网
    *   **差分曼切斯特编码：**
        *   若码元为1，则前半个码元的电平与上一个码元的后半个码元的电平相同，0相反(或者互换)
        *   优点：有时钟信号，可实现自同步，抗干扰性较好
        *   应用：局域网
    *   **4B/5B编码：**
        *   将欲发送数据流的每4位作为一组，按照4B/5B编码规则将其转换成相应的5位码，5位码一共32种组合，用前面的16位表示数据，后面16位作为控制码(帧的开始和结束，线路的状态信息等)或保留

![编码](/Users/coffeeboy/Desktop/考研/assets/a2e51276773e46b8a98470d7ab8f94cc-7538950-7538952-7538964-7538972.png)

*   **数字数据调制为模拟信号：**(调制，用调制器)
    *   **幅移键控(ASK)：**通过改变载波信号的**振幅**来表示数字信号1和0，频率和相位都不改变，缺点：抗干扰能力差
    *   **频移键控(FSK)：**通过改变载波信号的**频率**来表示数字信号1和0，振幅和相位都不改变，优点：容易实现，抗干扰能力强，应用广泛
    *   **相移键控(PSK)：**通过改变载波信号的**相位**来表示数字信号1和0，频率和振幅都不改变，还分为：绝对调相，相对调相
    *   **正交振幅调制(QAM)：**在频率相同的前提下，将ASK和PSK结合起来，形成叠加信号，设波特率为B，采用m个相位，每个相位有n种振幅，则该QAM技术的数据传输速率$R = Blog_2{(mn)}$，单位b/s

![调制](/Users/coffeeboy/Desktop/考研/assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MTg4Mzg5MA==,size_16,color_FFFFFF,t_70.png)

*   **模拟数据编码为数字信号：**(编码，用PCM编码器)
    *   **采样定理：**在通信领域，带宽是指信号最高频率和最低频率之差，单位为Hz，设原始信号中f为最大频率，那么**采样频率F必须大于或等于f的两倍才能保证采样后的数字信号完整**，采样定理也称**奈奎斯特定理**
    *   模拟数据编码为数字信号分为三步：采样，量化，编码
        *   **采样：**对模拟信号进行周期性扫描，把时间上连续的信号变成时间上离散的信号
        *   **量化：**把采样得到的电平幅值按照一定的分级标度转化为对应的数字值并取整数，采样和量化的实质是分割和转换
        *   **编码：**把量化的结果转换为与之对应的二进制编码



*   **模拟数据调制为模拟信号：**(调制，放大器调制器)
    *   **频分复用技术(FDM)：**为了实现传输的有效性，可能需要更高的频率，可以使用频分复用技术(FDM)，充分利用带宽资源
    *   应用：电话机和本地局交换机



### 交换技术

*   **电路交换：**在进行数据传输前，两个结点之间建立一条独占的链路，直到通信结束才释放，在数据传输的过程中，用户始终占用**端到端的固定传输带宽**，分为三个阶段：连接建立，数据传输，连接释放
    *   **优点：**
        *   通信时延小
        *   有序传输
        *   没有冲突：不同的通信双方有不同的信道
        *   适用范围广：能传模拟信号也能传数字信号
        *   实时性强
        *   控制简单
    *   **缺点：**
        *   建立连接时间长
        *   线路独占
        *   灵活性差
        *   难以规格化：电路交换时，数据直达，不同类型，不同规格，不同速率的终端很难相互进行通信，也不能进行差错控制



*   **报文交换：**数据交换的单位为报文，报文携带有**目标地址，源地址等信息**，在交换节点采用**存储转发**的传输方式
    *   **优点：**
        *   无建立时延
        *   动态分配线路：结点可自己选择最合适的线路
        *   提高线路可靠性：若某条传输路径发生故障，可重新选择一条
        *   提高线路利用率：不像电路交换固定占用一条线路，而是在不同的时间一段一段地部分占用
        *   提供多目标服务：一个报文可以同时发送给多个目的地址
    *   **缺点：**
        *   存在转发时延
        *   对报文的大小没有限制，要求网络结点有较大的缓存空间
    *   **应用：**
        *   早期的电报通信网
        *   现在使用较先进的分组交换



*   **分组交换：**解决报文交换中大报文传输的问题，采用**存储转发方式**，把大的数据块划分为合理的小数据块，再加上一些必要的控制信息，构成分组(Packet)
    *   **优点：**
        *   无建立时延
        *   提高线路利用率
        *   简化了存储管理：划分成了固定的分组
        *   加速传输：流水线形式
        *   减少了出错概率和重发数据量
    *   **缺点：**
        *   存在转发时延
        *   需要传输额外的信息量
        *   当分组交换采用**数据报服务**，可能出现失序，丢失，重复分组的情况，分组到达目的地要对分组进行排序
    *   **应用：**
        *   适合于计算机之间的突发式数据通信



*   要传输的数据量很大且传送时间远大于呼叫时间时，采用**电路交换**
*   端到端的通路由多段链路组成时，采用**分组交换**



### 分组交换的两种方式

*   分组交换根据其**通信子网向端点系统提供的服务可分为：**面向连接的虚电路方式和无连接的数据报方式(都由网络层提供)
*   **数据报方式：**在**端系统中实现的高层协议**先将发送的报文拆分为若干带有序号的数据单元，在**网络层**加上地址等控制信息后形成数据报分组(网络层的PDU)，**中间结点**存储分组找到最佳的路由后，尽快转发每个分组直到目的结点
    *   **特点：**
        *   不需要建立连接
        *   对故障的适应能力强
        *   存储转发的时延小，提高网络的吞吐量
        *   资源利用率高，不独占某条链路
        *   传输不保证可靠性，分组不一定按序到达
        *   分组包含发送端和接受端的完整地址
        *   存储转发中排队等待处理会带来时延
*   **虚电路方式：**分组发送前建立一条虚电路，分为三个阶段：虚电路建立，数据传输，虚电路释放
    *   **特点：**
        *   建立和拆除虚电路需要时间，但是适合**长时间，频繁的数据交换**
        *   虚电路的路由选择体现在连接建立阶段，建立之后就确定了传输路径
        *   虚电路提供了可靠的通信功能，分组有序到达目的地，能进行流量控制
        *   某个结点或链路发生故障那么所有经过该结点或链路的虚电路都将失效
        *   分组首部不包含目的地址，而是包含虚电路标识符，相对于数据报方式开销更小



*   **比较：**

|                    | 数据报方式                 | 虚电路方式                                         |
| ------------------ | -------------------------- | -------------------------------------------------- |
| 连接的建立         | 不需要                     | 需要                                               |
| 目的地址           | 每个分组在首部都有         | 仅在建立连接阶段使用，之后使用长度较短的虚电路序号 |
| 路由选择           | 每个分组独立地进行路由选择 | 属于同一条虚电路的分组按照同一路由转发             |
| 分组顺序           | 不保证有序到达             | 保证有序到达                                       |
| 可靠性             | 不可靠，可靠性由用户保证   | 可靠，由网络保证                                   |
| 故障适应性         | 适应能力强                 | 所有故障结点的虚电路都不能工作                     |
| 差错控制和流量控制 | 用户主机进行流量控制       | 可由分组交换网负责也可由用户主机负责               |



### 习题

*   一条可双向通信的电路往往包含两个信道，一条是发送信道，一条时接收信道，另外，多个通信用户共用通信电路时，每个用户在该通信电路上都会有一个信道

*   并行传输：距离短，速度快，所以在计算机内部通常使用并行传输

*   曼切斯特编码适合传输二进制数字信号

*   脉冲编码调制(PCM)，常用于使用数字信号编码模拟数据，比如声音

*   把基带信号直接传送到通信线路(数字信道)上的传输方式称为**基带传输**，把基带信号经过调制后送到模拟信道上的传输方式称为**频带传输**，如果调制成**频分复用**的模拟信号送到模拟信道上传输就是**带宽传输**

*   以太网采用**曼切斯特编码**，城域网中使用以太网，波特率是数据率(速率)的两倍

*   局域网中采用**差分曼切斯特编码**

*   报文交换中，在交换结点中需要较大的存储空间，报文经过中间结点的接收，存储和转发时间较长，不能用于实时通信应用环境(语音，视频)

*   电路交换实时性好，传输时延小，但是**不具备差错控制和存储数据**的能力，无法纠正传输过程中发生的数据差错，适合于交互式会话类通信

*   数据报方式也**不具备差错控制和流量控制的能力，也不保证分组按序到达**

*   分组交换的数据报方式通过高层协议如TCP的差错控制和流量控制来保证传输的可靠性和有序性

*   虚电路包括永久性虚电路和交换型虚电路，永久性虚电路是提前定义好的，不需要任何建立时间，交换型虚电路是临时性连接，需要建立时间

*   数据报服务，每个分组在传输过程中都必须携带源地址和目的地址

*   传输时间 = 排队时延 + 处理时延 + 传输时延 + 发送时延

    *   没有特殊说明的话 排队时延和处理时延都不考虑

    *   一个分组的发送时延 = 分组大小/传输速率

    *   对于分组交换，**总传输时间 = 最后一个分组从源地址发送完毕的时间 + 最后一个分组在链路上传输和等待的时间**，其中             最后一个分组从源地址发送完毕的时间 = 所有分组大小/传输速率

        最后一个分组在链路上传输和等待的时间 = 分组大小/传输速率 * (所有结点-1) + 一个结点的处理时延 * (所有结点-1) + 传播时延



![image-20231018165755480](/Users/coffeeboy/Desktop/考研/assets/image-20231018165755480-7619477.png)



## 物理层传输媒介(并不属于物理层)

### 传输介质

*   **传输介质：**也称传输媒体，是数据传输系统中**发送设备**与**接收设备**之间的**物理通路**
*   传输介质分为：导向传输介质，非导向传输介质
    *   导向传输介质：电磁波被导向沿着固体媒介(铜丝或光纤)传播
    *   非导向传输介质：空气，真空，海水



### 双绞线

*   **双绞线：**由两根采用一定规则**并排绞和**的，**相互绝缘**的**铜**导线组成
*   **绞和：**用来减少对相邻导线的电磁干扰
*   屏蔽双绞线(STP)：在双绞线的外面加上一层用金属丝编织成的屏蔽层，可以**进一步提高抗电磁干扰的能力**
*   非屏蔽双绞线(UTP)：外面不带屏蔽层的双绞线
*   **特点：**
    *   价格便宜，最常用的传输介质
    *   带宽取决于**铜线的粗细和传输的距离**
    *   模拟传输和数字传输都可以使用双绞线
    *   距离太远时，对于模拟传输，要用**放大器**放大衰减的信号
    *   距离太远时，对于数字传输，要用**中继器**将失真的信号整形



### 同轴电缆

*   **同轴电缆：**由内导体，绝缘层，网状编织屏蔽层，塑料外层构成
*   按照**特性阻抗数值的不同**分为：
    *   50$\Omega$同轴电缆：用于传送基带数字信号，也称基带同轴电缆，在局域网中应用广泛
    *   75$\Omega$同轴电缆：用于传送宽带信号，也称宽带同轴电缆，在有线电视系统中应用广泛
*   **特点：**
    *   价格比双绞线贵
    *   由于**外导体屏蔽层**，有良好的抗干扰特性，广泛用于传输较高速率的数据，传输距离更远



### 光纤

*   **光纤：**由纤芯，包层构成，光纤很细，用来传导光波，包层较纤芯有较低的折射率，用来对光波进行折射
*   **光纤通信：**利用光导纤维(光纤)传递光脉冲来进行通信
*   有光脉冲表示1，无光脉冲表示0，利用光来表示数据，光的频率为$10^8MHz$，所以光纤通信系统的带宽范围极大
*   传播原理：当光线从高折射率的介质射向低折射率的介质时，其折射角将大于入射角，只要入射角大于某个临界角度，就会出现**全反射(不进行折射，全部反射)**，光就能沿着光纤传输
*   **多模光纤：**将从不同角度入射的多条光线在一根光纤中传输，光源为发光二极管，只适合于近距离传输
*   **单模光纤：**光纤的直径减小到只有一个光的波长时，光线一直向前传播，不会产生多次反射
*   单模光纤的纤芯很细，直径只有几微米，制造成本较高，光源为定向性很好的半导体激光器，适合远距离传输，而且不需要中继器
*   **光纤的特点：**
    *   通信容量非常大
    *   传输损耗小，中继距离长，对远距离传输特别经济
    *   抗雷电和电磁干扰性能好
    *   无串音干扰，保密性好
    *   体积小，重量轻



### 无线介质

*   无线通信广泛应用于移动电话领域，构成蜂窝式无线电话网
*   **无线电波：**无线电波具有较强对穿透力，可以传输很长的距离，**使信号向所有方向传播**，如无线手机通信，无线局域网(WLAN)
*   **微波，红外线，激光：**高带宽的无线通信，都需要发送方和接收方之间存在一条**视线通路**，有很强的方向性，都沿直线传播
*   其中**红外通信和激光通信**把要传输的信号分别转换为各自的信号格式，即红外信号和激光信号，再直接在空间中传播
*   对于**微波通信**，频率较高，频段范围宽，通信信道的容量大，沿直线传播，用中继站来接力
*   卫星通信利用地球同步卫星作为中继站来进行**微波通信**，通信容量大，距离远，覆盖广，**缺点**是保密性差，端到端传播时延长



### 物理层接口的特性

*   物理层的主要任务是**确定与传输媒体的接口有关的一些特性：**
    *   **机械特性：**指明接口所用接线器的形状，尺寸，引脚数目，引脚排列，固定和锁定装置
    *   **电气特性：**指明接口电缆的各条线上出现的电压的范围
    *   **功能特性：**指明线上电平的电压代表的含义
    *   **过程特性/规程特性：**指明对于不同功能的各种可能事件的出现顺序
*   常见的物理层接口标准：EIA RS-232-C，ADSL，SONET/SDH





### 习题

*   传统以太网采用**广播**的方式发送信息，同一时间只允许一台主机发送信息，属于**半双工通信**
*   同轴电缆的带宽更高得益于**高屏蔽性**
*   卫星通信具有**成本高，传播时延长，受气候影响大，保密性差，误码率较高**的特点
*   物理层的**电气特性**规定了信号的电压高低，传输距离



![image-20231018171852465](/Users/coffeeboy/Desktop/考研/assets/image-20231018171852465-7620734.png)



## 物理层设备

### 中继器

*   **原理：**信号再生
*   **功能：**将信号整形放大再转发出去

*   **具有存储转发功能：**代表能连接两个不同的协议
*   中继器只有两个端口，且仅作用于信号的电气部分，而不管是否有错误数据或不适于网段的数据
*   中继器两端的网络部分是网段，工作在物理层，没有存储转发功能，即**不能连接两个具有不同速率的局域网，两端使用同一个协议**
*   **5-4-3规则：**在采用粗同轴电缆的10BASE5以太网规范中，互相串联的中继器不能超过4个，4个中继器串联的5段通信介质中只有3段能挂载计算机，其余2段只能用作扩展通信范围的链路段，不能挂载计算机
*   **放大器：**放大模拟信号，原理为将衰减的信号放大
*   **中继器：**放大数字信号，原理为将衰减的信号整形再生



### 集线器

*   **原理：**信号再生
*   **功能：**将信号整形放大再转发出去
*   **集线器(Hub)：**实质上是一个多端口的中继器，一个端口入，多个端口出
*   如果同时有两个或多个端口输入，则输出发生冲突致使数据无效
*   Hub主要使用双绞线组建共享网络，在交换式网络中，Hub直接与交换机相连
*   由Hub组成的网络是共享式网络，但逻辑上是一个总线网
*   Hub只能工作在**半双工状态**，因此网络的吞吐率受到影响



### 习题

*   **转发器**是物理层设备，不能识别数据链路层的帧，也无寻址功能，只具有放大信号的功能
*   两个网段要能在物理层进行互联要求**数据传输速率相同**，要能在数据链路层互联要求**数据传输速率和数据链路层可以都相同**
*   **放大器**通常用于远距离传输模拟信号，同时也会**放大噪声，引起失真**
*   **网桥**用于连接两个网段以扩展物理网络的覆盖范围
*   **路由器**是网络层的互连设备，可以实现不同网络的互连





# 数据链路层

## 数据链路层的功能

*   **主要作用：**加强**物理层**传输**原始比特流**的功能，将物理层提供的**可能出错的物理连接**改造为**逻辑上无差错的数据链路**，对网络层表现为无差错的链路



### 1.为网络层提供服务

*   对**网络层**而言，数据链路层的基本任务：将源机器中来自网络层的数据传输到目标机器的网络层
*   数据链路层为网络层提供以下服务：
    *   无确认的无连接服务：适用于实时通信，误码率较低的情况，如**以太网**
    *   有确认的无连接服务：适用于误码率较高的情况，如**无线通信**
    *   有确认的面向连接服务：适用于实时性，可靠性较高的情况



### 2.链路管理

*   **链路管理：**数据链路层连接的**建立，维持，释放**过程------主要用于面向连接的服务
*   在多个站点共享同一物理信道的情况下(如局域网)如何在要求通信的站点间分配和管理信道也属于数据链路层的管理



### 3.成帧

*   **成帧：**将**网络层**的分组封装成帧
*   将一段数据的前后分别添加首部和尾部，首部和尾部中含有很多控制信息，**作用是：**确定帧的界限(帧定界)
*   **帧同步：**接收方应能够从接收到的二进制比特流中区分帧的起始和终止
*   **最大传送单元(MTU)：**帧的数据部分的长度上限
*   **透明传输：**不管所传数据是什么样的比特组合，都应能够在链路上传送



### 4.流量控制

*   **流量控制：**限制发送方的数据流量，使其发送速率不超过接收方的接受能力
*   流量控制除了数据链路层之外还有很多高层协议具有这个功能
*   **数据链路层的流量控制**控制的是点到点之间数据链路上的流量，**传输层的流量控制**控制的是端到端之间的流量
*   OSI中，数据链路层具有流量控制的功能，在TCP/IP中，流量控制被移到了传输层



### 5.差错控制

*   **差错控制：**使发送方确定接收方是否正确收到由其发送的数据的方法
*   **位错：**帧中某些位出现了差错，采用循环冗余校验(CRC)方式发现位错，通过自动重传请求(ARQ)方式来重传出错的帧
*   ARQ法只需返回很少的控制信息就可有效地确认所发数据帧是否被正确接收
*   **帧错：**帧的丢失，重复或失序等错误，引入定时器和编号机制来处理帧错



### 习题

*   数据链路层协议的功能：
    *   定义数据格式--成帧
    *   提供结点之间的可靠传输--数据链路管理
    *   控制对物理传输介质的访问--介质访问控制(MAC)子层完成
*   电路管理功能由物理层提供
*   为终端结点隐蔽物理传输的细节是物理层的功能
*   差错控制中的编号机制：为防止接收方不会接收到重复帧
*   差错控制中的定时器：防止帧在传送过程中丢失
*   网际控制报文协议(ICMP)是网络层协议
*   PPP，SLIP，HDLC都是数据链路层协议





## 成帧

*   目的：把比特组合成帧作为单位发送，为了在出错时只重发出错的帧，而不重发全部数据，从而提高效率
*   **组帧：**将网络层递交的分组封装成帧
*   组帧主要解决：帧定界，帧同步，透明传输，组帧时既要加首部也要加尾部
*   一共有四种方法实现组帧



### 1.字符计数法

*   **字符计数法：**在帧**头部**使用一个计数字段来标明帧内字符数(也包括本身)
*   缺点：如果计数字段出错，会失去同步，导致后面的数据全错



### 2.字符填充的首尾定界符法

*   **字符填充法：**用特定字符来定界一帧的开始和结束，控制字符SOH表示帧的开始，EOT表示帧的结束，数据部分包括控制字符，填充转义字符ESC(实现透明传输)



### 3.零比特填充的首尾标志法

*   **零比特填充法：**使用一个特定的比特模式来表示一个帧的开始和结束(比如01111110)，为了防止误判，在信息位中遇到连续的5个‘1’时在其后自动添加一个‘0’，接收方在收到5个连续的‘1’时自动删除后面的‘0’
*   优点：容易由硬件来实现，性能优于字符填充法
*   零比特填充法允许数据帧包含任意个数的比特，也允许每个字符的编码包含任意个数的比特



### 4.违规填充法

*   **违规填充法：**用冗余编码作为控制信号
*   在物理层进行比特编码时，通常采用违规填充法
*   只适用于采用冗余编码的特殊编码环境(局域网IEEE802标准)



### 习题

*   由于**字符计数法中计数字段的脆弱性**和**字符填充法实现上的复杂性和不兼容性**，目前常采用零比特填充法和违规填充法



## 差错控制

*   通常利用**编码控制**来进行差错控制，主要有：自动重传请求ARQ和前向纠错FEC
*   自动重传请求ARQ：接受端检测到差错时，设法通知发送端重发，直到接收到正确的码字为止
*   前向纠错FEC：接收端不但能发现差错，而且能确定比特串的错误位置
*   差错控制分为：检错编码和纠错编码



### 1.检错编码

*   **检错编码**：通过附加冗余位，有效数据变化时，相应的冗余位也发生改变来达到检错的功能
*   常见的检错编码：奇偶校验法和循环冗余码



*   **奇偶校验法**
    *   分为奇校验法和偶校验法
    *   奇校验法：在附加一个校验元后，码长为n的码字中“1”的个数为奇数
    *   偶校验法：在附加一个校验元后，码长为n的码字中“1”的个数为偶数
    *   只能检测**奇数个**位出错的情况



*   **循环冗余法(CRC)**
    *   又称多项式码
    *   给定一个m bit的帧或报文，发送器生成一个r bit的序列，称为**帧检验序列(FCS)**
    *   具体实现过程：
        *   双方先约定一个多项式G(x)，这个多项式的最高位和最低位都为‘1’
        *   特传送数据M，共有m位
        *   G(x)的阶为r，在M的后面加上r个‘0’构成除数X
        *   用除数X除以G(x)得到余数R，如果R=0，则接收方认为无错
    *   循环冗余码(CRC)具有纠错功能，只是数据链路层仅使用了检错功能



### 2.纠错编码

*   最常见的纠错编码是：**海明码**
*   海明码：**看书P69**
*   **海明距：**两个码字对应位置二进制数不同的个数，比如10001和01001，前面2个的值不同，所以码距为2，一个编码集合中，取最小的码距
*   检错d位，码距为d+1，纠错d位，码距为2d+1





### 习题

*   通信信道的噪声分为：热噪声和冲击噪声
*   热噪声是信道固有的，引起的差错是随机差错，可以通过 提高信噪比来降低影响
*   冲击噪声是由外界电磁干扰引起的，引起的差错是突发差错，是引起传输差错的主要原因，无法通过提高信噪比来避免
*   海明码可以纠正一位的错误，可以检测二位的错误
*   海明码满足条件：$n+k<=2^k-1$，n为有效数据的位数，k为校验位的位数
*   CRC校验位的位数是G(x)的最高次数





## 流量控制与可靠传输机制

*   流量控制涉及对链路上的帧的发送速率的控制，以使接收方有足够的缓冲空间来接收每个帧
*   常见的有**停止-等待协议**和**滑动窗口协议**



### 停止-等待协议

*   发送方每发送一帧，都要等待接收方的应答信号，之后才能发送下一帧
*   传输效率很低



### 滑动窗口

*   分为发送窗口$W_T$和接收窗口$W_R$
*   只有接收窗口向前滑动(同时接收方发送了确认帧)时，发送窗口**才有可能**(只有发送方收到确认帧后才一定)向前滑动
*   各种协议的窗口大小：
    *   停止-等待协议：发送窗口为1，接收窗口为1
    *   后退N帧协议：发送窗口>1，接收窗口为1
    *   选择重传协议：发送窗口>1，接收窗口>1，一般发送窗口大小=接收窗口大小
*   窗口的大小在传输过程中是固定的



### 可靠传输机制

*   数据链路层的可靠传输使用**确认和超时重传**来完成
*   将确认捎带在一个回复帧中，称为捎带确认
*   自动重传请求(ARQ)通过接收方请求发送方重传出错的数据帧来回复出错的帧
*   ARQ分为：停止-等待ARQ，后退N帧ARQ(GBN)，选择性重传ARQ(SR)，后两种又称为连续ARQ协议



### 1.GBN(后退N帧)

*   **累计确认：**对某一数据帧的确认就表明该数据帧和此前所有的数据帧都已正确收到
*   GBN中$1<W_T<=2^n-1$，n代表n个比特对序编号

*   弊端：批量重传



#### 1.1发送方

*   **上层的调用**	
    *   上层要发送数据时，发送方先检查发送窗口是否已满，如果**未满**，则产生一个帧并将其发送，如果**已满**，发送方将数据返回上层，要求上层等一会再发(实际实现中，发送方可以缓存这些数据，窗口不满时再发送帧)
*   **收到ACK**
    *   GBN中，对n号帧的确认采用**累计确认**的方式
*   **超时事件**
    *   发送法每发送一个帧，都启动该帧的定时器，如果定时器到还没有收到来自接收方的确认帧则再发送一次



#### 1.2接收方

*   **按序接收**
    *   接收方接收到n号帧，则发送n号确认帧给发送方，并且接收窗口向前移动，等待n+1号帧，如果接收到窗口外的序号帧，都丢弃

*   **重复确认帧**
    *   如果接收方接收的序号帧不是所期待的帧则重复发送上一个确认帧



### 2.SR(选择性重传)

*   SR：只重传出错的数据帧或计数器超时的数据帧
*   一旦接收方怀疑帧出错，就发送一个否定帧NAK给发送方，要求发送方对NAK中指定的帧进行重传
*   SR中$W_T<=2^{n-1}$,发送窗口大小通常等于接收窗口大小



#### 2.1发送方

*   **上层的调用**
    *   从上层收到数据后，SR发送方检查下一下可用于该帧的序号，如果序号位于发送窗口中，则发送数据帧，否则要么将数据缓存，要么返回给上层
*   **收到ACK**
    *   如果收到ACK，发送方将该ACK对应的帧标志为已确认，如果是窗口的下界，则窗口向前移动到具有最小序号的未确认帧处，如果窗口移动了之后窗口内有未发送的序号帧，则发送



#### 2.2接收方

*   **来者不拒**
    *   接收方将确认一个正确接收的帧而**不管其是否按序**，失序的帧会被缓存，并返回确认帧，直到窗口内的所有帧都收到才将一批帧交付给上层，然后向前移动滑动窗口



*   当发送窗口过大时：发送窗口将帧都发出同时打开定时器，接收窗口接收后发出确认帧并将接收窗口向前移，这时如果确认帧都丢失了定时器时间到发送方又发送第一轮的数据而这时接收方已经在接收第二轮的序号帧了，所以无法正常工作



### 习题

*   **信道效率：**又称信道利用率，指发送方在一个发送周期内，有效地发送数据所占用的时间/整个发送周期的时间
*   **发送周期：**发送方从开始发送数据到收到第一个确认帧的时间
*   信道吞吐率 = 信道利用率 * 发送方的发送速率
*   计算最小窗口大小，以最短的帧长来算
*   窗口总数指的是序号最大值，发送窗口大小最大为窗口总数-1
*   信道带宽直接制约数据的传输速率，传输速率一般是小于等于信道带宽
*   选择重传(SR)中：发送窗口大小+接收窗口大小<=$2^n$



![image-20231023185335390](/Users/coffeeboy/Desktop/考研/assets/image-20231023185335390-8058418.png)





## 介质访问控制

*   介质访问控制完成的任务：为使用介质的每个结点**隔离**来自同一信道上**其他结点所传送的信号**，以协调活动结点的传输
*   介质访问控制子层：用来决定**广播信道**中**信道分配**的协议
*   介质访问控制有：
    *   静态划分信道
        *   信道划分介质访问控制
    *   动态划分信道
        *   随机访问介质访问控制
        *   轮询访问介质访问控制



### 1.信道划分介质访问控制

*   **多路复用：**传输介质的带宽超过传输单个信号所需的带宽，**通过在一条介质上同时携带多个传输信号**来提高传输系统的利用率
*   **信道划分的本质 ：**通过**分时，分频，分码**的方法把一条广播信道逻辑上分为几条两个结点之间的子信道
*   信道划分介质访问控制分为：频分多路复用，时分多路复用，波分多路复用，码分多路复用
*   **频分多路复用(FDM)：**
    *   将多路基带信号调制到不同频率载波上，再叠加形成一个复合信号的多路复用技术(共享频率)
    *   每个子信道的带宽可不相同，但总和不超过信道总带宽，在实际中，为了防止子信道之间的干扰，相邻信道之间加入“保护频带”
    *   优点：充分利用了传输介质的带宽，系统效率较高，技术比较成熟实现简单
*   **时分多路复用(TDM)：**
    *   将一个物理信道按时间分成若干时间片，轮流地分配给多个信号使用(共享时间)
    *   每个时刻传送的都是一个设备的信号，一段时刻是按时间分割的多个设备的信号
    *   统计时分多路复用(STDM)：TDM的一种改进，不再使时间片固定，而是动态地分配时间片
*   **波分多路复用(WDM)：**
    *   光的频分多路复用，在一根光纤上传输多种不同波长(频率)的光信号，最后再用波长分解复用器将各路波长分解出来(共享波长)
    *   光波处于频谱的高频段，有很高的带宽
*   **码分多路复用(CDM)：**
    *   采用不同编码来区分各路原始信号(共享频率和时间)
    *   **码分多址(CDMA)：**每个比特时间划分成m个短的时间槽，称为码片，通常m为64或128
    *   每个结点都被分配一个码片序列，比如m为8，A站点的码片序列00011011代表‘1’，反码代表‘0’，每个站点的码片序列必须相互正交，即规格化内积为0(任何一个码片向量与自身的内积为1，与自身的反码内积为-1，与正交的内积为0)
    *   当数据到达接收方时，想要得到哪个站点的数据就乘以那个站点的码片序列，如果结果为1，则数据为1，如果为-1，则数据为0
    *   优点：频谱利用率高，抗干扰能力强，保密性强，语音质量好，减少投资和降低运行成本，主要用于**无线通信系统，移动通信系统**



### 2.随机访问介质访问控制

*   所有用户根据自己的意愿随机发送信息，占用信道全部速率
*   分为ALOHA协议，CSMA协议，CSMA/CD协议，CSMA/CA协议，**核心思想：**胜利者通过争用获得信道，又称争用型协议
*   随机访问介质控制实质上是一种将**广播信道转化为点到点信道的行为**

*   **ALOHA协议：**(不监听)
    *   纯ALOHA协议：
        *   需要发送数据时，不进行检测就发送，在一段时间内未收到确认就认为发生了冲突，等待一段**随机**时间后再发，直到成功
        *   **网络负载G：**T时间内所有站点发送的总帧数
        *   **网络吞吐量S：**T时间内成功发送的平均帧数
        *   纯ALOHA的$S=Ge^{-2G}$，最大为0.184
    *   时隙ALOHA协议：
        *   将时间划分为一段段等长的时隙，只能在每个时隙开始时发送帧
        *   每个帧到达后都要等待一段小于时隙的时间才能再次发送
        *   如果发生冲突，和纯ALOHA一样，等待一段随机时间后在时隙的开始处重发，直到成功
        *   时隙ALOHA的$S=Ge^{-G}$，最大为0.368
*   **CSMA协议：**(监听)
    *   载波监听多路访问(CSMA)在ALOHA的基础上多了一个载波监听装置
    *   分为：1-坚持CSMA，非坚持CSMA，p-坚持CSMA
    *   **1-坚持CSMA：**
        *   监听到信道闲，发送数据的概率为1，监听到信道忙，继续坚持监听信道
        *   传播延迟对该协议影响大，如果A发送数据但是还没到达B，B此时监听信道仍然是闲状态
        *   多个结点监听到信道空闲后同时发送数据
    *   **非坚持CSMA：**
        *   监听到信道闲，发送数据的概率为1，监听到信道忙，放弃监听，随机时间后再监听
        *   用处：降低了多个结点等待信道空闲后同时发送数据导致冲突的概率，但也会增加数据在网络中的延迟时间
    *   **p-坚持CSMA：**
        *   用于时分信道
        *   监听到信道闲，发送数据的概率为p，1-p的概率推迟到下一个时隙再监听，监听到信道忙，等待到下一个时隙开始时监听
        *   概率发送的用处：降低**1-坚持CSMA中**多个结点检测到信道空闲同时发送数据的冲突概率
        *   坚持监听的用处：克服**非坚持CSMA中**由于随机等待而造成的延迟时间长的缺点
*   **CSMA/CD协议：**(碰撞检测)
    *   适用于总线形网络或半双工网络环境，也叫使用于有线连接到局域网
    *   发送前监听到信道闲，则发送数据，发送中检测到碰撞，则停止数据发送，等待随机时间后，重新开始尝试发送数据
    *   **争用期：**以太网端到端往返时间2$\tau$,$\tau$为单程传播时延
    *   **最短帧长：**总线传播时延 * 数据传输速率 * 2
    *   如果发送小于最小帧长的帧，需要在MAC子层中于数据字段的后面加入一个整数字节的填充字段，来保证以太网的MAC帧的长度不小于最短帧长
    *   CSMA/CD还能从冲突中恢复，采用**截断二进制指数退避算法**
        *   确定基本退避时间，一般取$2 \tau$
        *   定义参数k，代表重传次数，k = min[重传次数，10]
        *   从离散的整数集合$[0,1,...,2^k-1]$中取出一个数r，重传所需退避的时间就是(r * 基本退避时间)，也就是$2r\tau$
        *   当k==16时，抛弃此帧并向高层报告出错
    *   协议过程如下：
        *   **准备发送：**适配器从网络层获得一个分组，封装成帧，放入适配器的缓存
        *   **检测信道：**信道空闲，发送数据，信道忙，持续监听
        *   **发送中：**发送中适配器仍持续监听信道
            *   发送成功：在争用期一直未监听到碰撞，则发送成功
            *   发送失败：在争用期监听到碰撞，立即停止发送，适配器执行**指数退避算法**，等待一段时间后再回到检测信道阶段，如果k=16，停止重传并向上报错
*   **CSMA/CA协议：**(碰撞避免)
    *   CSMA/CD协议适用于有线连接到局域网，但是不能适用于无线连接的局域网，原因：
        *   接收信号的强度往往远小于发送信号的强度，且在无线介质上信号强度的动态变化范围很大，因此要实现碰撞检测，硬件花费大
        *   在无线通信中，并非所有的站点都能听见对方，存在“隐蔽站”的问题
    *   因此802.11标准定义了广泛应用于无线局域网的CSMA/CA协议，把碰撞检测改为碰撞避免
    *   碰撞避免：协议的设计要尽量降低碰撞发生的概率
    *   该协议每次发送帧会完整的发送
    *   802.11使用链路层确认/重传(ARQ)方案，即站点每通过无线局域网发送完一帧，在收到对方确认后才能继续发生下一帧
    *   收到确认后需要等待一段时间才能发送下一帧，这段时间称为**帧间间隔**，帧间间隔的长短取决于帧的类型，分为：
        *   SIFS(短IFS)：最短的IFS，使用SIFS的帧类型有：ACK帧，CTS帧，分片后的数据帧，所有回答AP探询的帧
        *   PIFS(点协调IFS)：中等长度的IFS，在PCF操作中使用
        *   DIFS(分布式协调IFS)：最长的IFS，用于异步帧竞争访问的时延
    *   只有检测到信道空闲且要发送的帧是第一个数据时才不使用退避算法，以下情况必须使用退避算法：
        *   在发送第一个帧前检测到信道忙
        *   每次重传
        *   每次成功发送后要发送下一帧
    *   协议过程如下：
        *   站点发送第一个数据，如果检测到信道闲，则在等待时间DIFS后，就发送整个数据帧
        *   如果检测到信道忙，执行CSMA/CA退避算法，选择一个随机回退值，一旦检测到信道忙，则计数器不变，只要信道空闲，计时器就倒计时
        *   当退避计时器减到0时(这时信道只能是空闲的)，站点就发送整个帧并等待确认
        *   若收到确认，则知道已发送的帧被成功接收，如果发送第二个帧，则从第二步开始，执行退避算法
        *   如果在规定时间内也就是重传计时器到0时没有收到ACK，就必须重传
    *   **为了解决“隐蔽站”问题：**
        *   源站在发送数据之前先**广播一个很短的请求发送RTS控制帧**，包含源地址，目的地址，这次通信所持续的时间
        *   若信道空闲，目的地址**广播一个允许发送CTS控制帧**，包含这次通信所需的时间
        *   其他站在收到CTS后，在CTS帧内指明的时间内将抑制发送
        *   CTS帧的目的：
            *   给源站明确的发送许可
            *   指示其他站点在预约期内不要发送
        *   只有当数据帧长度超过某一数值时，使用RTS和CTS帧才比较有利



*   CSMA/CD和CSMA/CA主要有如下区别：
    *   CSMA/CD可以检测冲突，但无法避免，CSMA/CA无法在发送数据的同时检测碰撞，只能尽量避免碰撞
    *   **传输介质不同：**CSMA/CD用于总线形以太网，CSMA/CA用于无线局域网802.11a/b/g/n
    *   **检测方式不同：**CSMA/CD通过电缆中的电压变化来检测，CSMA/CA采用能量检测，载波检测，能力载波混合检测



### 3.轮询访问：令牌传递协议

*   轮询访问中，用户不能随机地发送信息，而要通过一个集中控制的监控站，以循环方式轮询每个结点，再决定信道的分配
*   令牌传递协议：一个令牌沿着环形总线在各结点间一次传递，令牌是一个特殊的MAC控制帧，本身并不包含信息，仅控制信道的使用
*   当站点希望传输帧时，必须等待令牌，一旦收到令牌则立即启动发送帧，包含目的站点地址
*   协议过程如下：
    *   网络空闲时，环路中只有令牌帧在循环传递
    *   令牌传送到一个需要发送帧的站点时，该站点就修改令牌的一个标志位，并在令牌中附加自己需要传输的数据，将令牌变成一个数据帧，然后将这个数据帧发送
    *   数据帧沿着环路传输，接收到的站点一边转发数据，一边查看帧的目的地址，将目的地址与自身地址进行匹配，如果相同，接收站就**复制**该数据帧
    *   当数据帧到达源站点，通过检验返回的帧来查看数据传输过程中是否出错，有错就重传
    *   源站点传送玩数据之后，重新产生一个令牌，并传递给下一个站点
*   轮询介质访问控制适用于负载很高的广播信道(多个结点在同一时刻发送数据概率很大的信道)



### 4.习题

*   静态划分信道，各结点分开使用信道，不会出现碰撞
*   CSMA/CD协议中定义的冲突检测时间(争议期)指：信号在**最远两个端点之间**往返传输的时间
*   以太网规定最短帧长为64B
*   ALOHA 通信负载 = 每个时隙的发送次数
*   带宽 = 信道利用率 * 传输速率



![image-20231025101247567](/Users/coffeeboy/Desktop/考研/assets/image-20231025101247567-8199969.png)



## 局域网

*   **局域网(LAN)：**是指在一个较小的地理范围内，将各种计算机，外部设备，数据库系统等通过**双绞线，同轴电缆**等连接介质互相连接起来，组成**资源和信息共享**的计算机互连网络
*   **特点：**
    *   为一个单位所拥有，且地理范围和站点数目均有限
    *   所有站点共享较高的总带宽(即较高的数据传输速率)
    *   较低的时延和较低的误码率
    *   各站为平等关系而非主从关系
    *   能进行广播和组播
*   局域网的特性主要由**拓扑结构，传输介质，介质访问控制方式**，其中最重要的介质访问控制方式决定局域网的技术特性
*   局域网的**拓扑结构**有：
    *   星形结构
    *   环形结构
    *   总线形结构
    *   星形和总线形结合的复合型结构
*   局域网的**传输介质**有：
    *   双绞线，主流传输介质
    *   铜缆
    *   光纤
*   局域网的**介质访问控制方式**有：
    *   CSMA/CD --- 总线形局域网
    *   令牌总线 ---总线形局域网
    *   令牌环 --- 环形局域网
*   三种特殊的局域网拓扑实现：
    *   以太网(**目前使用范围最广的局域网**)，逻辑拓扑是总线形结构，物理拓扑是星形或扩展星形结构
    *   令牌环(IEEE 802.5)，逻辑拓扑是环形结构，物理拓扑是星形结构
    *   FDDI(光纤分布数字接口，IEEE 802.8)，逻辑拓扑是环形结构，物理拓扑是双环结构
*   IEEE 802标准定义的局域网参考模型对应于OSI的物理层和数据链路层，并将数据链路层分为了逻辑链路控制LLC和媒体接入控制MAC
    *   MAC：
        *   与接入传输媒体有关的部分
        *   向上层屏蔽对物理层访问的各种差异，提供对物理层的统一访问接口
        *   组帧，拆卸帧，比特传输差错控制，透明传输
    *   LLC：
        *   与传输媒体无关
        *   向网络层提供无确认无连接，面向连接，有确认无连接，高速传送四种连接服务类型
*   **IEEE 802.3标准：**是一种基带总线形的局域网标准，描述物理层和数据链路层的MAC子层的实现方法



### 以太网

*   以太网是指符合**DIX Ethernet V2标准**的局域网，但该标准与IEEE 802.3差别很小，所以通常将IEEE 802.3局域网简称为以太网

*   以太网使用两种方式来简化通信：

    *   采用无连接的工作方式，不对发送的数据帧编号，也不要求接收方发送确认，尽最大努力交付数据，提供不可靠服务，对于差错的纠正由高层完成
    *   发送的数据都采用曼切斯特编码，每个码元的中间出现一次电压转换，接收端利用这种电压转换方便地把位同步信号提取出来

*   以太网的传输介质：粗缆，细缆，双绞线，光纤

*   | 参数         | 10BASE5            | 10BASE2            | 10BASE-T          | 10BASE-FL     |
    | ------------ | ------------------ | ------------------ | ----------------- | ------------- |
    | 传输媒体     | 基带同轴电缆(粗缆) | 基带同轴电缆(细缆) | 非屏蔽双绞线(UTP) | 光纤对(850nm) |
    | 编码         | 曼切斯特编码       | 曼切斯特编码       | 曼切斯特编码      | 曼切斯特编码  |
    | 拓扑结构     | 总线形             | 总线形             | 星形              | 点对点        |
    | 最大段长     | 500m               | 185m               | 100m              | 2000m         |
    | 最多结点数目 | 100                | 30                 | 2                 | 2             |

*   BASE代表基带传输，10代表10Mb/s，100代表100Mb/s，5代表500m，2代表200m实际185m，T代表双绞线，F代表光纤

### 网卡

*   **网卡**上装有处理器和存储器，是工作在数据链路层的网络组件
*   网卡与局域网的通信是通过**电缆或双绞线**以**串行方式**进行的
*   网卡与计算机的通信是通过**计算机主板上的I/O总线以并行方式进行的**
*   网卡的重要功能是进行数据的串并转换
*   网卡能实现与局域网传输介质之间的物理连接和电信号匹配，涉及帧的发送和接收，帧的封装和拆封，介质访问控制，数据的编码和解码，数据缓存功能
*   网卡控制主机对介质的访问，所以网卡也工作在物理层
*   每块网卡出厂时都有唯一的代码，称为**介质访问控制(MAC)地址**：用于控制主机在网络上的数据通信
*   数据链路层设备(网桥，交换机)都使用各个网卡的MAC地址



### MAC

*   每块网卡的MAC地址也称物理地址
*   MAC地址一共6字节，高24位为厂商代码，低24位为厂商自行分配的网卡序列号
*   以太网MAC帧格式有两种标准：DIX Ethernet V2标准(即以太网V2标准)和IEEE 802.3标准
*   以下为以太网V2标准：

![在这里插入图片描述](/Users/coffeeboy/Desktop/考研/assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0ODI0MTQ4,size_16,color_FFFFFF,t_70-8153442-8153446.png)

*   **前导码：**使接收端和发送端时钟同步	
    *   前7个字节为前同步码，用来快速实现MAC帧的比特同步
    *   后一个字节是帧开始定界符，用来表示后面的信息就是MAC帧
*   **目的地址：**6个字节，用来指明目的地址
*   **源地址：**6个字节，用来指明源地址
*   **类型：**2个字节，用来指出数据域中携带的数据应交给哪个协议实体处理
*   **数据：**46-1500个字节，包含高层的协议消息，以太网采用CSMA/CD协议，最短64B，而首部和尾部的长度为18字节，所以数据段为46-1500字节，数据较少时必须加以填充
*   **校验码(FCS)：**4个字节，校验范围从目的地址到数据段的末尾，算法采用32位循环冗余码(CRC)
*   802.3帧格式与以太网V2标准的不同之处在于：
    *   802.3帧格式用长度域代替了DIX帧中的类型域，指出数据域的长度



### 高速以太网

*   **高速以太网：**速率达到或超过100Mb/s的以太网
*   分为100BASE-T 以太网，吉比特以太网，10吉比特以太网
*   **100BASE-T 以太网：**
    *   在**双绞线**上传送100Mb/s基带信号的星形拓扑结构以太网，使用CSMA/CD协议(半双工)，支持全双工和半双工模式
    *   802.3标准的MAC帧格式，最短帧长不变，但是一个网段段最大电缆长度减小到100m，帧间间隔从9.6us改为0.96us
*   **吉比特以太网：**
    *   千兆以太网，允许在1Gb/s速率下用全双工和半双工方式，使用CSMA/CD协议(半双工)
    *   802.3标准的MAC帧格式，与10BASE-T 和 100BASE-T技术向后兼容
*   **10吉比特以太网：**
    *   使用**光纤**传输，只工作在全双工方式，所以不使用CSMA/CD协议
    *   802.3标准的MAC帧格式，还保留了802.3中的以太网最小帧长和最大帧长
*   以太网是**可扩展的，灵活的，易于安装，稳健性好**



### IEEE802.11 无线局域网

*   无线局域网分为：有固定基础设施的无线局域网(带路由器的)和无固定基础设施的无线局域网(移动的)

*   **有固定基础设施的无线局域网：**

    *   **固定基础设施：**指预先建立的，能覆盖一定地理范围的固定基站
    *   IEEE 制定了对于有固定基础设施的协议：802.11系列协议标准，包括802.11a/b/g/n
    *   802.11使用**星形拓扑**结构，其中心点称为接入点(AP)，在MAC层使用**CSMA/CA协议**
    *   **Wi-Fi：**使用802.11协议标准的局域网
    *   **基本服务集BSS：**802.11标准规定无线局域网的最小构件
        *   一个BSS包含一个接入点和若干移动站
    *   **AP：**基本服务集中的基站，负责不同BSS之间的通信
        *   安装AP时必须分配一个不超过32字节的服务集标识符SSID，和一个信道，SSID指的是AP的无线局域网的名字
        *   AP与AP之间的通信是使用有线传输的
    *   **基本服务区BSA：**指一个基本服务集覆盖的地理范围
        *   无线局域网的BSA一般不超过100m
    *   **扩展服务集ESS：**一个基本服务集通过AP连接到一个分配系统DS，然后再连接到另一个基本服务集
        *   **分配系统DS：**使扩展的服务集对上层的表现就像一个基本服务集一样
        *   ESS还可以通过Portal(门户)设备为无线用户提供到有线连接的以太网接入

    ![img](/Users/coffeeboy/Desktop/考研/assets/62975f98ec90aa15f832465fd2aff60f-8197232.png)

*   **无固定基础设施的无线局域网：**

    *   又称自组网络
    *   自组网络没有AP，各结点之间地位平等，中间结点为转发结点，都具有路由器的功能
    *   自组网络与**移动IP**不同
        *   移动IP技术使漫游的主机可以使用多种方法连接到因特网，其核心网络功能仍然是基于固定网络中的路由选择协议
        *   自组网络上把移动性扩展到无线领域中的自治系统，具有自己特定的路由选择协议，可以不与因特网相连



### 802.11 的MAC帧

*   802.11帧分为：数据帧，控制帧，管理帧
*   **数据帧：**
    *   MAC首部，共30字节
    *   帧主体，即帧的数据部分，不超过2312字节，比以太网的最大长度长很多
    *   帧检验序列FCS尾部，共4字节

![img](/Users/coffeeboy/Desktop/考研/assets/92440a78c5a0d656d2cb3aae9b98de61-8197251.png)

*   MAC首部中最重要的是4个地址字段，其中前3个字段的情况如下：

    ![img](/Users/coffeeboy/Desktop/考研/assets/64962a01a67c70cde5e904b6769e6864-8197362.png)

*   其中地址1点目的地址为中间结点的地址，地址3中的目的地址为最终目的地址
*   路由器与BSS之间的通信过程：(重点是路由器接口R1将**IP地址**封装成**802.3帧**，AP将**802.3帧**转换成**802.11帧**)
    *   AP通过有线连接到路由器，而路由器是**网络层**设备，看不见链路层的AP，只知道通信结点的IP地址，AP只认识MAC地址
    *   路由器从IP数据报中获取结点的IP地址，并使用ARP(网络层协议)获取结点的MAC地址，路由器接口R1将该IP数据报封装成802.3帧，该帧的源地址字段是R1的MAC地址，目的地址字段是A的MAC地址
    *   AP收到802.3帧后，将802.3帧转换为802.11帧，再找到对应结点



### VLAN

*   以太网存在的问题：
    *   以太网是一个广播域，当一个以太网中的计算机太多时，会出现大量的广播帧，特别是经常使用的ARP和DHCP协议
    *   一个单位的不同部门共享一个局域网，对信息保密和安全不利
*   引入**虚拟局域网VLAN：**将一个较大的局域网分割成一些较小的与地理位置无关的逻辑上的VLAN，每个VLAN是一个较小的广播域
*   **802.3ac标准**定义了支持VLAN的以太网帧格式的扩展，在以太网中插入一个**4字节**的标识符：VLAN标签，用来指明该帧的计算机是哪个VLAN的
*   插入了VLAN标签的帧称为**802.1Q帧**，因此以太网的最大帧长从1518字节变为1522字节
*   VLAN标签的前两个字节为**0x8100**，指明这是一个802.1Q帧，后两字节中，前4位无用，后12位是VLAN的标识符VID，表示该802.1Q帧是属于哪个VLAN，插入VID后，802.1Q帧的FCS必须重新计算
*   **同一交换机下的同一虚拟局域网中的设备通信：**通过交换机传输标准的以太网帧
*   **不同交换机下的同一虚拟局域网中的设备通信：**源结点传输标准以太网帧给自己的交换机，交换机传输802.1Q帧给另一个交换机，另一个再拿走插入的VLAN标签传输标准的以太网帧给目的结点
*   **同一交换机下的不同虚拟局域网中的设备通信：**需要通过上层的路由器来解决



![image-20231025103806778](/Users/coffeeboy/Desktop/考研/assets/image-20231025103806778-8201489.png)





### 习题

*   以太网的逻辑拓扑是总线形结构，物理拓扑是星形或扩展星形结构
*   广域网工作在OSI参考模型的下三层
*   放大器是用来加强带宽信号(用于传输模拟信号)的设备
*   中继器是用来加强基带信号的设备(大多数以太网采用基带传输)
*   域名解析用于把主机名解析成对应的IP地址，MAC地址通常由ARP协议查得
*   路由器可以隔离广播域
*   在使用静态地址的系统中，如果2个硬件使用相同的MAC地址，那么他们都不能正常通信
*   以太网各层的功能：
    *   物理层：信号的编码与译码，比特的传输与接收
    *   MAC子层：组帧和拆帧，比特差错检测，寻址，竞争处理
    *   LLC子层：建立和释放数据链路层的逻辑连接，提供与高层的接口，差错控制，给帧加序号
*   吉比特以太网的物理层有两个标准：IEEE802.3z和IEEE802.3ab，前者采用光纤通信，后者采用4对UTP5类线(无屏蔽双绞线)
*   VLAN建立在交换技术基础上，以软件方式实现逻辑分组和管理
*   三种划分VLAN的方式：基于端口，基于MAC地址，基于IP地址(网络层地址)
*   链路聚合：解决交换机之间的带宽瓶颈问题的技术
*   VLAN的优点：
    *   有效地共享网络资源
    *   简化网络管理
    *   提高网络安全性
*   IEEE 802局域网参考模型和OSI参考模型有什么异同？
    *   物理层：
        *   两个标准的物理层都负责物理连接并在媒体上传输比特流，主要任务是**描述传输媒体接口的一些特性**

    *   数据链路层：
        *   两个标准都通过一些数据链路层协议，在不可靠的传输信道上实现可靠的数据传输，负责帧的传送与控制
        *   不同：
            *   局域网中由于各站共享网络公共信道，所以数据链路层必须具有**媒体访问控制功能(如何分配信道，如何避免或解决信道争用)**
            *   又由于局域网采用的拓扑结构与传输媒体多种多样，相应的媒体访问控制方法也多种，因此在数据链路功能中应该将与传输媒体有关和无关的分开，局域网参考模型就分成了**媒体访问控制(MAC)子层和逻辑链路控制(LLC)子层**
            *   LLC子层实际上是高层协议与任何一种MAC子层之间的标准接口

    *   网络层：
        *   局域网参考模型中没有网络层，在局域网中任意两个结点之间只有唯一的一条链路，不需要进行路由选择和流量控制，所以不需要网络层




## 广域网

*   **广域网：**指覆盖范围很广的长距离网络

*   广域网是因特网的核心部分，其任务是长距离运送主机所发送的数据

*   连接广域网各结点交换机的链路都是**高速链路**，首要考虑**通信容量是否足够大**的问题

*   广域网由一些**结点交换机和连接这些交换机的链路**组成

*   结点交换机的作用：将分组存储转发，为了提高网络的可靠性，一个结点交换机往往与多个结点交换机相连

*   局域网使用的协议主要在数据链路层，广域网使用的协议主要是在网络层

*   局域网与广域网的区别：

    |              | 广域网                                                       | 局域网                                                       |
    | ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
    | 覆盖范围     | 很广，通常跨区域                                             | 较小，通常在一个区域内                                       |
    | 连接方式     | 结点之间点对点连接，但为了提高网络可靠性，一个结点交换机往往与多个结点交换机相连 | 普遍采用多点接入技术                                         |
    | OSI参考模型  | 物理层，数据链路层，网络层                                   | 物理层，数据链路层                                           |
    | 联系与相似点 | 广域网和局域网都是互联网的重要组成构件，二者平等             | 在广域网和局域网中的主机在网内进行通信，只需要使用其网络的物理地址 |
    | 着重点       | 强调资源共享                                                 | 强调数据传输                                                 |

*   广域网中的一个重要问题是**路由选择和分组转发**

    *   路由选择协议负责搜索分组从某个结点到目的结点的最佳传输路由，以便构造路由表，再从路由表中构造出转发表
    *   分组是通过转发表进行转发

*   两种广域网数据链路层协议：PPP协议，HDLC协议



### PPP协议

*   **点对点协议PPP：**是使用串行线路通信的面向字节的协议

*   设计目的：用来通过拨号或专线方式建立点对点连接发送数据，使其成为各种主机，网桥和路由器之间简单连接的一种简单方案

*   PPP的信息字段中放入的数据是IP数据报，帧格式中有帧校验序列FCS字段，使用硬件进行CRC校验，可以保证无差错接收

*   PPP协议由三个部分组成：

    *   **链路控制协议LCP：**一种扩展链路控制协议，用来建立，配置，测试和管理数据链路
    *   **网络控制协议NCP：**PPP协议允许同时采用多种网络层协议，每个不同的网络层协议要用一个相应的NCP来配置，为网络层协议建立和配置逻辑连接
    *   **一个将IP数据报封装到串行链路的方法：**IP数据报在PPP中就是其信息部分，信息部分的长度受最大传输单位MTU的限制

    ![img](/Users/coffeeboy/Desktop/考研/assets/ppp.png)

    *   **标志字段F：**值为7E，若出现在信息字段中，使用控制转义字节7D做填充
    *   **地址字段A：**值为FF
    *   **控制字段C：**值为03
    *   **协议段：**说明信息段运载的是什么种类的分组
    *   **信息部分：**0-1500字节，因为PPP是点对点的，并不是总线形，所以不采用CSMA/CD协议，最短字长没有要求
    *   **帧校验FCS：**2个字节，循环冗余码校验中的冗余码，校验区包含A，C，协议段，信息部分

*   PPP协议的特点：

    *   PPP提供差错检测但不提供纠错功能，只保证无差错接收(硬件进行CRC校验)，是不可靠的传输协议，不使用序号和确认机制

    *   仅支持点对点的链路通信，不支持多点线路

    *   PPP只支持全双工链路

    *   PPP是面向字节的，如果信息字段出现和标志字段一样的比特组合：

        *   PPP用在异步线路，采用字符填充法

        *   PPP用在SONET/SDH等同步线路，协议规定采用硬件来完成比特填充



### HDLC协议

*   **高级数据链路控制(HDLC)协议：**面向比特的数据链路层协议
*   使用“0比特插入法”实现透明传输，易于硬件实现
*   全双工通信，有较高的数据链路传输效率
*   所有帧采用CRC校验，对信息帧进行顺序遍号，防止漏发或重发，传输可靠性高
*   传输控制功能与处理功能分离，具有较大的灵活性

![HDLC协议的基本概念和帧_从站_02](/Users/coffeeboy/Desktop/考研/assets/resize,m_fixed,w_1184-8222850.png)

*   与PPP协议相比没有**协议段**

*   PPP协议是面向字节的，HDLC协议是面向比特的
*   PPP比HDLC多一个2字节的协议字段，当协议字段值为0x0021时，信息字段是IP数据报
*   PPP不使用序号和确认机制，只保证无差错接收(CRC校验)，而端到端差错检测由高层协议负责，HDLC的信息帧使用了编号和确认机制，能提供可靠传输



### 习题

*   TCP/IP协议族主要包括：TCP，IP，ICMP，IGMP，ARP，RARP，UDP，DNS，FTP，HTTP
*   PPP两端的网络层可以运行不同的网络层协议
*   PPP支持两种身份认证：PAP认证，CHAP认证，PPP的安全性没有CHAP高
*   PPP可用于拨号连接，因此支持动态分配IP地址
*   HDLC的三种数据操作方式：正常响应模式，异步响应模式，异步平衡模式
    *   正常响应模式和异步响应模式属于非平衡配置方式
    *   正常响应模式中，主战向从站传输数据，从站在收到主战的许可后响应传输
*   根据控制字段最前面2位将HDLC帧划分为：信息帧(I帧)，监督帧(S帧)，无编码帧(U帧)

























## 数据链路层设备

*   两个或多个以太网通过网桥连接后，就成为一个覆盖范围更广的以太网，原来的每个以太网称为**一个网段**
*   网桥工作在**链路层的MAC子层**，可以使以太网各网段成为隔离开的碰撞域
*   网桥必须具有路径选择的功能，接收到帧后，要决定正确的路径，将该帧转送到相应的目的局域网站点
*   **局域网交换机，又称以太网交换机**，实质上是一个多端口的网桥，工作在**数据链路层**，通常工作在**全双工方式**
*   以太网交换机原理：
    *   检测端口来的数据帧的源MAC地址和目的MAC地址
    *   与系统内部的动态查找表进行比较
        *   源MAC地址不在查找表中，将地址放入查找表中，广播这个帧
        *   如果在查找表中，则不进行广播，直接传送到目的端口
*   以太网交换机优点：对于10Mb/s的共享式以太网，拥有N个端口的交换机的总容量是N*10Mb/s
*   以太网交换机的特点：
    *   以太网交换机的每个端口都直接与单台主机相连，一般工作在全双工方式
    *   交换机能同时连通多对端口，使每对相互通信的主机能像独占通信媒体那样，无碰撞地传输数据
    *   交换机是即插即用设备，其内部的帧的转发表是通过自学算法自动地建立起来的
    *   交换机使用专用的交换结构芯片，交换速率较高
    *   交换机独占传输媒体的带宽
    *   利用交换机能方便实现虚拟局域网VLAN，VLAN不仅能隔离冲突域，还能隔离广播域
*   以太网交换机采用两种交换模式：
    *   直通式交换机，只检查帧的目的地址，速度快，但缺乏智能性和安全性，无法支持具有不同速率的端口的交换
    *   存储转发式交换机，将收到的帧缓存到高速缓存器中，并检查数据是否有错
        *   无错则通过查找表转换成输出端口将该帧发送
        *   有错则丢弃
        *   优点：可靠性高，能支持不同速率端口间的转换，缺点：延迟较大
*   交换机的自学功能：
    *   **过滤：**决定一个帧是应该转发到某个端口还是丢弃
    *   **转发：**决定一个帧应该被移动到哪个接口
    *   交换机的过滤和转发借助**交换表**完成
    *   交换表中的一个表项至少包含：
        *   一个MAC地址
        *   连通该MAC地址的交换机端口
    *   自学：
        *   交换机接收来自端口的数据
        *   如果交换表中有该数据的MAC地址，则直接发送到目的端口
        *   如果没有，则写入表中，将数据进行广播
        *   交换表中的每个表项都设有一定的有效时间，过期的表项会自动删除，符合连接到交换机的主机随时变化的情况
        *   这种自学方法使交换机能即插即用



### 习题

*   中继器和集线器都属于物理层设备，网桥和局域网交换机属于数据链路层设备
*   交换机的优点：
    *   每个端口结点所占用的带宽不会因为端口结点数目的增加而减少，且整个交换机的总带宽会随着端口结点的增加而增加
    *   利用交换机实现虚拟局域网VLAN，不仅可以隔离冲突域也能隔离广播域
    *   交换机能隔离冲突域，工作在全双工状态，使网络中多对结点同时通信，提高了网络的利用率
    *   交换机的每个端口都有其自己的冲突域，所以不会因为冲突而丢失帧
*   路由器具有较大的传输时延，处理分组报头的工作由软件完成，处理时间长
*   局域网交换机和网桥由硬件进行帧的转发
*   集线器的每个端口都具有收发功能，当某个端口收到信号，立即向所有其他端口转发
*   传输时延：路由器>网桥>局域网交换机>集线器
*   碰撞域(冲突域)：指共享同一信道的各个站点可能发生冲突的范围
    *   物理层不能分割冲突域，也不能分割广播域
    *   数据链路层能分割冲突域，不能分割广播域
    *   网络层既能分割冲突域，也能分割广播域
*   一个共享式以太网数据传输速率为10Mb/s，共有N个用户，使用交换机时：
    *   对于半双工工作方式：每个端口的速率为10Mb/s，总容量是N/2*10Mb/s
    *   对于全双工工作方式：每个端口的速率为20Mb/s，总容量是N*10Mb/s
*   直通交换只检查目的地址，共6B





# 网络层

## 功能

*   **设计思想：**向上只提供简单灵活的，无连接的，尽最大努力交付的数据报服务，也就是不可靠的
    *   优点：导致网络的造价大大降低，运行方式灵活，能够适应多种应用，网络中的路由器比较简单，价格低廉
    *   缺点：所传送的分组可能出错，丢失，重复，失序或超时



### 异构网络互联

*   **网络互联：**指将两个以上的计算机网络，通过一定的方法，用一些中间设备(又称中继系统)相互连接起来
*   中继系统根据**层次**分为：
    *   物理层中继系统：转发器，集线器
    *   数据链路层中继系统：网桥或交换机
    *   网络层中继系统：路由器
    *   网络层以上的中继系统：网关
*   物理层和数据链路层只是把一个网络扩大了，从网络层来看仍然是同一个网络，所以网络互联通常是指**用路由器进行网络互联和路由选择**，路由器是一台专用计算机，用于在互联网中进行路由选择
*   TCP/IP体系在网络互联上采用的做法是**在网络层采用标准化协议，但相互连接的网络可以是异构的**
*   **虚拟互联网络/逻辑互联网络：**指原本异构的各种物理网络通过都使用**IP协议**使得从网络层上看起来是一个统一的网络
*   使用IP协议的虚拟互联网络简称为**IP网络**
    *   优点：当IP网上的主机进行通信时，就好像在一个单个网络上通信一样，而看不见互联的各网络的具体异构细节



### 路由与转发

*   路由器的两个功能：**路由选择，分组转发**
    *   **路由选择：**确定哪一条路径，根据特定的路由选择协议构造出路由表，同时经常或定期地和相邻的路由器交换路由信息而不断地更新和维护路由表(**按照复杂的分布式算法，根据从各相邻路由器所得到的关于整个网络拓扑的变化情况，动态地改变所选择的路由**)
    *   **分组转发：**当一个分组到达时所采取的动作，处理通过路由器的数据流，转发表查询，转发及相关的队列管理和任务调度(**路由器根据转发表将用户的IP数据报从合适的端口转发出去**)
*   路由选择算法——路由表——转发表
    *   转发表：使查找过程最优化
    *   路由表：对网络拓扑变化的计算最优化



### SDN

*   网络层可抽象地划分为**数据平面/转发层面**和**控制平面**
    *   数据平面：实现转发
    *   控制平面：路由选择
*   **软件定义网络(SDN)：**采用集中式的控制平面和分布式的数据平面，控制平面通过**控制-数据接口**对数据平面上的路由器进行集中式控制，方便软件来控制网络
*   传统互联网中：路由器既有转发表又有路由选择软件(既有数据平面也有控制平面)
*   SDN中：路由器只**收到分组，查找转发表，转发分组**，而路由选择软件替换成控制平面上的**远程控制器**
*   远程控制器掌握各主机和整个网络的状态，为每个分组计算出最佳路由，通过**Openflow协议**将转发表(SDN中称为流表)下发给路由器，所以路由器不再相互交换路由信息
*   SDN的可编程性为开发者们提供强大的编程接口，使得网络具有很好的编程性
    *   **北向接口(对上层)：**对上层应用开发者提供的编程接口，提供丰富的API，开发者在此基础上设计应用而不必关心底层硬件细节
    *   **南向接口(对下层)：**SDN控制器和转发设备建立双向会话的接口，通过不同南向接口协议(如Openflow)，SDN控制器可兼容不同的硬件设备，同时可以在设备中实现上层应用的逻辑
    *   **东西向接口(内部)：**SDN控制器集群内部控制器之间的通信接口，用于增强整个控制平面的可靠性和可扩展性

*   **优点：**
    *   全局集中式控制和分布式高速转发，既利于控制平面的全局优化，又利于高性能的网络转发
    *   灵活可编程与性能的平衡，控制和转发功能分离后，使得网络可以由专用的自动化工具以编程方式配置
    *   降低成本，控制和数据平面分离后，尤其是在使用开放的接口协议后，就实现了网络设备的制造与功能软件的开发相分离，从而有效降低了成本
*   **缺点：**
    *   安全风险，集中管理容易受攻击，如果崩溃，整个网络会受到影响
    *   瓶颈问题，原本分布式的控制平面集中化后，随着网络规模扩大，控制器可能成为网络性能的瓶颈



### 拥塞控制

*   **拥塞：**在通信子网中，因出现过量的分组而引起网络性能下降的现象
*   轻度拥塞：随着网络负载的增加，网络的吞吐量明显小于正常的吞吐量
*   死锁状态：网络的负载继续增大，网络的吞吐量下降到零
*   拥塞控制**主要解决的问题**：如何获取网络中发生拥塞的信息，从而利用这些信息进行控制，以避免由于拥塞而出现分组的丢失，以及严重拥塞而产生网络死锁的想象
*   拥塞控制的**作用**：确保子网能够承载所达到的流量，涉及到主机，路由器和路由器内部的转发处理过程
*   拥塞控制和流量控制的区别：
    *   流量控制：指在发送端和接收端之间的点对点通信量的控制，主要抑制发送端发送数据的速率，以便使接收端来得及接收
    *   拥塞控制：确保通信子网能够传送待传送的数据，涉及网络中所有的主机，路由器及导致网络传输能力下降的所有因素
*   拥塞控制的方法：
    *   开环控制：设计网络时事先将有关发生拥塞的因素考虑周全，力求网络在工作时不发生拥塞
    *   闭环控制：采用监测网络系统去检测哪里发生了拥塞，再将拥塞信息传到合适的地方



### 习题

*   网络的**异构性**：指传输介质，数据编码方式，链路控制协议及不同的数据单元格式和转发机制，这些特点分别在**物理层和数据链路层定义**
*   路由器是第三层设备，所以连接的局域网的**物理层，数据链路层，网络层的协议可以不同，但是网络层以上的高层协议必须相同**
*   路由表只保留到达目的地址的下一个路由器的地址，而不保留整个传输路径的信息，所以路由表通常包含**目的网络和到达该目的网络路径上的下一个路由器的IP地址**，采用目的网络可使每个路由表项包含很多目的主机IP地址，可减少路由表中的项目
*   路由器转发一个分组的过程(**存储转发机制**)：
    *   先接收整个分组，然后对分组进行错误检查
        *   出错：丢弃错误的分组
        *   正确：存储该分组，根据路由选择协议，将正确的分组转发到合适的端口
*   TCP属于传输层协议，FTP属于应用层协议，IP，ICMP属于网络层协议
*   Openflow协议是控制平面和数据平面之间的接口，SDN中路由器不再相互交换路由信息，由远程控制器计算出最佳路由





## 路由算法

*   路由器转发分组依靠路由表，路由表通过各种算法得到，从**能否随网络的通信量或拓扑自适应地进行调整变化**可分为：
    *   静态路由算法/非自适应路由算法
    *   动态路由算法/自适应路由算法



### 静态路由算法

*   **静态路由算法(非自适应路由算法)：**网络管理员手动配置的路由信息，网络的拓扑结构或链路的状态发生变化时，网络管理员手动修改路由表中相关的静态路由信息
    *   优点：简便，可靠，在负荷稳定，拓扑变化不大的网络中运行效果很好，广泛应用于高度安全性的军事网络和较小的商业网络
    *   缺点：路由更新慢，不适合于大型网络



### 动态路由算法

*   **动态路由算法(自适应路由算法)：**路由器上的路由表项通过相互连接的路由器之间彼此交换信息，按照一定的算法优化出来，这些路由信息会在一定时间内不断更新，以适应不断变化的网络，随时获得最优的寻路效果
    *   优点：路由更新快，适用大型网络，及时响应链路费用或网络拓扑变化
    *   缺点：算法复杂，增加网络负担
*   常见的动态路由算法分为：距离-向量路由算法和链路状态路由算法
*   **距离-向量路由算法：**所有结点都定期地将它们的整个路由选择表传送给所有与之直接相邻的结点
    *   路由选择表中包含：**到达目的地址最优路径上的下一个结点(出口处)**和**到达该目的地址的距离(经历路由器数量)**
    *   所有结点都监听来自其他结点传来的路由选择更新信息，在以下情况更新路由选择表：
        *   被通告一条新的路由，该路由在本结点的路由表中不存在，此时本地系统加入这条新的路由
        *   发来的路由信息中有一条路径的距离更小，用新路径替换旧路径
    *   更新报文的大小与通信子网的结点个数成正比
    *   最常见的距离-向量路由算法是RIP算法，采用“跳数“作为距离的度量
*   **链路状态路由算法：**要求每个参与该算法的结点都具有完全的网络拓扑信息，每个结点主动测试所有邻接结点的状态，每个结点定期将链路状态传播给所有其他结点
    *   三个特征：
        *   向本自治系统中的所有路由器发送信息，使用**洪泛法**，即路由器通过所有端口向所有相邻的路由器发送信息，每个相邻路由器又将此信息发送到它的所有相邻路由器(**这样网络中每个路由器都能接收到这个信息从而构建整个网络的拓扑结构计算最优路径**)
        *   发送的信息是与路由器相邻的所有路由器的链路状态，**链路状态：**说明本路由器与哪些路由器相邻及该链路的“度量”，对于OSPF算法，链路状态的“度量”主要表示费用，距离，时延，带宽(**也就是只把自己附近的情况发送出去**)
        *   只有当链路状态发生变化时，路由器才向所有路由器发送此信息
    *   一个路由器的链路状态只涉及到它的相邻结点，而与整个互联网的规模并无直接关系，因此链路状态路由算法可以用于大型的或路由变化频繁的互联网环境
    *   步骤：
        *   发现邻居节点，并了解邻居网络地址
        *   测量到邻居节点的距离或成本度量值
        *   构建一个包含自己所拥有信息的链路状态包
        *   将这个包广播到网络中，并接收其它路由器的链路状态包
        *   计算出当前节点到其它节点之间的最短路径（基于Dijkstra算法）
    *   优点：
        *   根据构建的全局网络拓扑结构独立计算路径，不依靠中间结点的计算
        *   易于查找故障
        *   链路状态报文只涉及与其相邻的路由器的联通状态，与网络的规模无关，有更好的规模可延展性
        *   快速收敛，能够在网络拓扑发生变化时，立即进行路由的重新计算，并及时向其他路由器发送最新的链路状态信息



### 层次路由

*   网络规模太大时，路由表成比例地增大，所以必须按照层次的方式进行，因特网将互联网划分为许多小的自治系统AS(一个自治系统中包含很多局域网)，因此因特网将路由选择协议分为：内部网关协议，外部网关协议
    *   **内部网关协议IGP/域内路由选择：**一个自治系统内部所使用的路由选择协议，具体协议有RIP，OSPF
    *   **外部网关协议/域间路由选择：**不同自治系统的路由器之间交换路由信息，并负责为分组在不同自治系统之间选择最优的路径，具体协议有BGP
*   OSPF将一个自治系统再划分为若干区域(Area)，每个路由器都知道在本区域内如何把分组路由到目的地的细节，但不用知道其他区域的结构





### 习题

*   在距离-向量路由协议中，路由器共享路由信息并使各台路由器掌握的网络情况达到一致所需的时间比较久，收敛速度慢会导致有些路由器的表更新慢，从而造成路由环路的问题，也就是“慢收敛”的现象
*   在分层路由后，路由器被划分为区域，每个路由器知道如何将分组路由到**自己所在区域内的目标地址，但对于其他区域内的结构毫不知情，不必知道其他网络的拓扑结构**





## IPv4

*   IPv4即现在普遍使用的IP协议，IP协议定义**数据传送的基本单元**——IP分组及其确切的数据格式
*   IP分组也包括一套规则，指明分组如何处理，错误怎么控制
*   IP协议还包括非可靠投递的思想，以及与此关联的分组路由选择的思想



### IPv4分组的格式

*   一个IP分组由首部和数据部分组成

*   **首部：**

    *   前一部分固定为20B，包括一些必须的标识符和数据
    *   首部20B后面是一些可选字段，长度可变，用来提供错误检测和安全等机制

*   **首部前20B：**

    *   版本，占4位，指IP协议的版本，目前广泛为4

    *   首部长度，占4位，最大15，**以4B为一个单位**，所以最大值为60B，最常用的首部长度为20B，此时不使用任何可选字段

    *   服务类型：占8位，TOS字段有3个位用来指定IP数据报的优先级（目前已经废弃不用），还有4个位表示可选的服务类型（最小延迟、最大呑吐量、最大可靠性、最小成本），还有一个位总是0

    *   总长度，占16位，指首部和数据之和的长度，**以1B为一个单位**，因此IP数据包的最大长度为$2^{16}-1$（65535B），但是受到数据链路层MTU的限制

    *   标识，占16位，每产生一个数据报就加一，为了在数据报分片时，使用相同的标识，表示是同一个数据

    *   标志，占3位，只有后两位有用，分别为中间位DF，最低位MF

        *   MF=1表示后面还有分片
        *   MF=0表示是最后一个分片
        *   DF=0表示允许分片

    *   片偏移，占13位，指出分组在分片后，某片在原分组中的相对位置，**以8B为一个偏移单位**

    *   生存时间(TTL)，占8位，数据报在网络中可通过的路由器数的最大值，若TTL减为0则该分组必须丢弃

    *   协议，占8位，指出此分组携带的数据使用何种协议，即分组的数据部分应上交给哪个协议进行处理，值为6代表TCP，值为17代表UDP

    *   首部校验和，占16位，只校验分组的首部，不校验数据部分

    *   源地址字段，占32位，标识发送方的IP地址

    *   目的地址字段，占32位，标识接收方的IP地址

        ![IP数据报格式](/Users/coffeeboy/Desktop/考研/assets/tcpip.ipformat.png)



### IP数据报分片

*   IP数据报中标识总长度的有16位，理论上最大为65535B，但是受到数据链路层MTU的限制，IP数据报的源和目的地路径上的各段链路可能使用不同的链路层协议，有不同的MTU，比如以太网的MTU是1500B，许多广域网的MTU不超过576B，当IP数据报的总长度超过MTU时就需要进行分片
*   分片时，首部中的3位标志位中，只有DF=0时该数据报才能被分片，MF=0则用来表示该数据报是最后一个片
*   目的主机在对片进行重组时，使用片偏移字段来确定片应放在原始IP数据报的哪个位置
*   分片中，除了最后一个片，其他所有片中的有效数据载荷都是8的倍数，因为片偏移以8B为一个单位

![img](/Users/coffeeboy/Desktop/考研/assets/a7e29f02964f8a93ff81be142c8b84966dcebd73.png)



### IPv4地址

*   连接到因特网上的每台主机(或路由器)都分配一个32位的全球唯一IP地址

*   IP地址由**互联网名字**和**数据地址分配机构ICANN进行分配**

*   互联网早期采用的是分类的IP地址

    ![img](/Users/coffeeboy/Desktop/考研/assets/v2-13c1daebb7b5706a847f4e727d9dacde_1440w.jpg)

*   IP地址都由**网络号**和**主机号**组成，即IP地址={<网络号>,<主机号>}

    *   网络号标识主机(或路由器)所连接到的网络

    *   主机号标识该主机(或路由器)

*   一个IP地址在整个因特网范围内是唯一的

*   特殊的IP地址：

    *   主机号全为0的：表示本网络本身，如202.98.174.0
    *   主机号全为1的：表示本网络的广播地址，又称**直接广播地址**，如202.98.174.255
    *   环回自检地址：表示任意主机本身，如127.X.X.X
    *   32位全为0的：表示本网络上的本主机，如0.0.0.0
    *   32位全为1的：表示整个TCP/IP网络的广播地址，又称**受限广播地址**，由于路由器的隔离广播域的能力，实际上代表本网络的广播地址

*   常用的三种类别IP地址的使用范围：

*   | 网络类别 | 最大可用网络数 | 第一个可用的网络号 | 最后一个可用的网络号 | 每个网络中的最大主机数 |
    | -------- | -------------- | ------------------ | -------------------- | ---------------------- |
    | A        | $2^7-2$        | 1                  | 126                  | $2^{24}-2$             |
    | B        | $2^{14}$       | 128.0              | 191.255              | $2^{16}-2$             |
    | C        | $2^{21}$       | 192.0.0            | 223.255.255          | $2^8-2$                |

    A类地址可用网络数为$2^7-2$的原因：IP地址全为0的地址表示网络本身，网络号为127的IP地址为环回自检地址

*   最大主机数都要减2的原因：主机号全为0代表网络本身，主机号全为1代表广播地址
    
*   IP地址的特点：
    *   每个IP地址都由网络号和主机号组成，因此IP地址是一种分等级的地址结构，分等级的好处：
        *   IP地址管理机构在分配IP地址时只分配网络号，而主机号则由得到该网络的单位自行分配，方便IP地址的管理
        *   路由器仅根据目的主机所连接的网络号来转发分组，从而减小了路由表所占的存储空间
    *   IP地址是标志主机(或路由器)和一条链路的接口，IP网络上的一个路由器必然至少应具有两个IP地址(每个端口分配一个)
    *   用转发器或桥接器(网桥等)连接的若干LAN仍然是同一个网络(同一个广播域)，因此网络号必须相同
    *   在IP地址中，所有分配到网络号的网络(无论是WAN还是LAN)都是平等的
    *   在同一个局域网上的主机或路由器的IP地址中的网络号必须是相同的，路由器总是具有两个或以上的IP地址，每个端口都有一个不同网络号的IP地址
*   现在广泛使用无分类IP地址，以上传统的分类IP地址已成历史



### 网络地址转换(NAT)

*   NAT：指将专用网络地址转换为公用地址，从而对外隐藏内部管理的IP地址
*   专用网本地IP地址是可重用的，大大节省了IP地址的消耗
*   NAT隐藏了内部网络结构，从而降低了内部网络受到攻击的风险
*   为了网络安全，划出了部分IP地址为私有地址，私有地址只用于LAN，不用于WAN连接(私有IP地址不能直接用于因特网，必须通过网关利用NAT把私有IP地址转换为因特网中合法的全球IP地址)
*   允许私有IP地址被LAN重复使用
*   私有IP地址网段：
    *   A类：1个A类网段：10.0.0.0——10.255.255.255
    *   B类：16个B类网段：172.16.0.0——172.31.255.255
    *   C类：256个C类网段：192.168.0.0——192.168.255.255
    *   **最大地址为192.168.255.255**
*   在因特网中的路由器对**目的地址为私有地址的数据报一律不进行转发**，这种采用私有IP地址的互联网络称为：**专用互联网或本地互联网**，私有IP地址也称为**可重用地址**
*   使用NAT时需要在专用网连接到因特网的路由器上安装**NAT软件**，NAT路由器至少有一个有效的外部全球IP地址
*   NAT转换表中存放着**{本地IP地址：端口}到{全球IP地址：端口}**的映射，通过映射，可让多个私有IP地址映射到一个全球IP地址
*   NAT路由器转发数据报时需要查看和转换传输层的端口号

*   NAT路由转发过程(主机A192.168.2.1通过路由器R1，203.10.2.6/30转发到路由器R2，203.10.2.2下子网里的主机B192.168.2.1)：
    *   A发送数据到B
    *   首先A发送数据到R1，源地址为192.168.2.1，目的地址为R2的外网IP地址：203.10.2.2
    *   R1收到数据后，通过NAT转换表将源地址改为203.10.2.6，目的地址为：203.10.2.2(这里R1起NAT功能)
    *   数据到达R2后，转发给主机B，源地址为203.10.2.6，目的地址为192.168.1.2(这里R2只起转发功能)

*   NAT表：

    *   | 外网       |      | 内网        |      |
        | ---------- | ---- | ----------- | ---- |
        | 全球IP地址 | 端口 | IP地址      | 端口 |
        | 203.10.2.2 | 80   | 192.168.1.2 | 80   |

        Web服务器默认端口为80




### 子网问题

*   两级IP地址的缺点：
    *   IP地址空间的利用率有时很低
    *   给每个物理网络分配一个网络号会使路由表变得太大而使网络性能变坏
    *   两级的IP地址不够灵活



#### 1.子网划分

*   **子网划分：**在IP地址中增加一个“子网号字段”，使二级IP地址变成了三级IP地址
*   子网划分的基本思路：
    *   子网划分纯属一个单位内部的事情，单位对外仍表现为没有划分子网的网络
    *   子网号是从主机号中借用若干比特，三级IP地址的结构：**{<网络号>,<子网号>,<主机号>}**
    *   在转发过程中，仍然是先找到连接到本单位网络上的路由器，然后路由器在收到数据报后，按目的网络号和子网号找到目的网络，最后将IP数据报直接交付到目的地址
*   划分子网只是对IP地址的主机号进行再划分，不改变网络号
*   子网中**主机号全为0**的地址为子网的网络号，**主机号全为1**的是子网的广播地址



#### 2.子网掩码

*   **子网掩码：**一个与IP地址相对应的，长32bit的二进制串，由一串1和跟随的一串0组成，1对应于IP地址中的网络号和子网号，0对应于IP地址中的主机号，计算机将IP地址和对应的子网掩码进行“与”，就可以得到子网地址。
*   IP地址为192.168.5.56，子网掩码为255.255.255.0，则子网地址为192.168.5.0
*   路由表中的除了有目的网络地址和下一跳地址外，还有同时给出该目的网络的子网掩码
*   在使用子网掩码的情况下：
    *   一台主机在设置IP地址信息的同时，必须设置子网掩码
    *   同属于一个子网的所有主机及路由器的相应端口，必须设置相同的子网掩码
    *   路由器的路由表中，所包含信息的主要内容有**目的网络地址，子网掩码，下一跳地址**



#### 3.无分类编制CIDR

*   **无域间路由选择CIDR：**使用网络前缀来代替子网络，网络前缀的位数可变
*   使用CIDR可以大幅度提高IP地址空间的利用率，减小路由器的路由表大小，提高路由转发能力
*   CIDR的IP地址形式：**{<网络前缀>,<主机号>}**
*   CIDR还使用**斜线记法**：IP地址/网络前缀所占比特数，网络前缀所占比特数=前多少号为网络号
*   IP地址为128.13.32.5/20，所以前20位为网络号，即网络号为128.13.32.0
*   将网络前缀都相同的连续IP地址组成“CIDR地址块”，一个CIDR地址块可以表示很多地址，这种地址的聚合称为**路由聚合/构成超网**
*   使用路由聚合可以使路由表中原本多个网络看成一个大网络，从而有利于减少路由器之间的信息交换，从而提高网络性能
*   CIDR地址块中的**主机数**一定是2的整数次幂，实际可指派的主机数为$2^N-2$，N代表主机号的位数，主机号全为0代表网络号，主机号全为1代表广播地址，网络前缀越短，该地址块中包含的主机数就越多
*   **最长前缀匹配(最佳匹配)：**使用CIDR时，路由表中的每个项目由“网络前缀”和“下一跳地址”组成，在查找路由表时可能得到不止一个匹配结果，这时应该选择最长网络前缀的路由，因为网络前缀越长，其地址块就越小，路由就越具体
*   CIDR查找路由表的方法：通常将无分类编制的路由表存放在一种层次式数据结构中，然后自上而下地按层次进行查找，最常用的数据结构是**二叉检索**
*   CIDR的优点在于网络前缀长度的灵活性



#### 4.网络层转发分组的过程

*   分组转发都是基于目的主机所在网络的，因为网络数远小于主机数，极大地压缩转发表的大小
*   分组到达路由器后，路由器根据目的IP地址的网络前缀来查找转发表，来决定下一跳的地址，转发表中每条路由必须有：目的网络，下一跳地址
*   当到达最后一个路由器时，才试图向目的主机进行直接交付
*   采用CIDR编址时，选择前缀最长的那个作为匹配的前缀，称为最长前缀匹配，为了更快地查找转发表，可以按照前缀的长短，进行**降序排列**
*   转发表中还可以增加两种特殊的路由：
    *   **主机路由：**对特定目的主机的IP地址专门指明一个路由，以方便网络管理员控制和测试网络，若特定主机的IP地址为a.b.c.d，则转发表中对应项的目的网络是a.b.c.d/32
    *   **默认路由：**用特殊前缀0.0.0.0/0表示默认路由，只要目的网络是其他网络(不在转发表中)，就一律选择默认路由
*   路由器执行的分组转发算法如下：
    *   从收到的IP分组的首部提取目的主机的IP地址D(即目的地址)
    *   若查找到特定主机路由(目的地址为D)，就按照这条路由的下一跳转发分组；否则从转发表的下一条(即按前缀长度的顺序)开始检查，执行第三步
    *   将这一行的子网掩码与目的地址D进行按位与运算，若运算结果与本行的前缀匹配，则查找结束，按照“下一跳”指出的进行处理(或直接交付本网络上的目的主机，或通过指定接口发送到下一跳路由器)；否则，若转发表还有下一行，则对下一行进行检查，重新执行第三步；否则如果没有下一行，执行第四步
    *   若转发表中有一个默认路由，则把分组传送给默认路由；否则，报告转发分组出错
*   得到下一跳路由器的IP地址后，并不是直接将该地址填入待发送的数据报，而是将该IP地址转换为MAC地址(**通过ARP协议**)，将此MAC地址放到MAC帧首部，然后根据这个MAC地址找到下一跳路由器
*   在不同网络中传送时，MAC帧中的源地址和目的地址要发生变化，但是网桥在转发帧时，不改变帧的源地址



### ARP协议

*   **IP地址与MAC地址的区别：**
    *   IP地址是网络层使用的地址，它是分层次等级的
    *   硬件地址是数据链路层使用的地址(MAC地址)，它是平面式的
    *   在网络层及网络层以上使用IP地址，IP地址放在IP数据报的首部
    *   在数据链路层使用MAC地址，MAC地址放在MAC帧的首部
    *   数据链路层负责将网络层的分组封装成MAC帧，MAC帧的数据部分就是IP数据报，所以数据链路层看不见IP地址
    *   在网络层只使用IP地址来完成寻址
    *   虽然在IP数据报首部中有源IP地址，但路由器只根据目的IP地址进行转发
    *   路由器由于互联多个网络，因此不仅有多个IP地址，也有多个硬件地址(MAC地址)
*   **地址解析协议(ARP)：**
    *   在实际网络的链路上最终使用的是硬件地址，所以我们需要完成IP地址到MAC地址的映射：地址解析协议ARP
    *   ARP用于解决同一个局域网上的主机或路由器的IP地址和硬件地址的映射关系
    *   每台主机都设有一个**ARP高速缓存**，用来存放本局域网上各主机和路由器的IP地址到MAC地址的映射表，称为**ARP表**
    *   使用ARP来动态维护ARP表
    *   ARP工作在网络层，工作原理为：
        *   主机A向本局域网上的某台主机B发送IP数据报
        *   先在ARP高速缓存中查看有无主机B的IP地址
            *   有：根据映射得到MAC地址，再将MAC地址写入MAC帧，然后通过局域网将该MAC帧发往此硬件地址
            *   没有：使用目的MAC地址为FF-FF-FF-FF-FF-FF的帧来封装并广播**ARP请求分组(广播发送)**，使**同一个局域网**里的所有主机都收到此ARP请求，主机B在收到该ARP请求后，向主机A发送**ARP响应分组(单播发送)**，主机A收到ARP响应分组后就将该映射写入ARP缓存，然后按查询到的硬件地址发送MAC帧
    *   如果是在不同局域网上进行通信，就要通过ARP找到源局域网中的路由器的一个端口的硬件地址，把分组发送给这个路由器，让这个路由器把分组转发到下一个网络
    *   ARP请求分组是广播发送的，ARP响应分组是普通的单播，即从一个源地址发送到一个目的地址
    *   ARP的四种典型情况：
        *   源主机和目的主机**在同一个局域网内**：源主机通过ARP找到目的主机的硬件地址
        *   源主机和目的主机**不在同一个局域网内**：源主机通过ARP找到与源局域网连接的路由器的端口的硬件地址，剩下的工作交给路由器来完成
        *   **路由器**发送数据报到**自身所连接的一个局域网中的一个主机**：路由器通过ARP找到目的主机的硬件地址
        *   **源路由器**发送数据报到**另一个路由器所连接的一个局域网中的主机**：源路由器通过ARP找到另一个路由器的硬件地址，剩下的工作交给另一个路由器来完成
    *   从IP地址到硬件地址的解析是自动进行的，主机的用户并不知道这种地址解析过程



### DHCP协议

*   **动态主机配置协议(DHCP)：**常用于给主机动态地分配IP地址，提供了即插即用的联网机制，允许一台计算机加入新的网络和获取IP地址而不用手工参与
*   DHCP是**应用层协议**，基于UDP
*   DHCP的工作原理：使用客户/服务器模式
    *   需要IP地址的主机在启动时向DHCP服务器广播发送**发现报文**，这时主机就成为DHCP客户
    *   本地网络上所有主机都能收到此广播报文，但只有DHCP服务器才回答此广播报文
    *   DHCP服务器先在其数据库中查找该计算机的配置信息，如果找到，则返回找到的信息，如果没找到，从服务器的IP地址池中取一个地址分配给该计算机
    *   DHCP服务器的回答报文称为**提供报文**
*   DHCP服务器和DHCP客户端的交换过程：
    *   DHCP客户机广播**DHCP发现**信息，试图找到网络中的DHCP服务器，以便获得一个IP地址，源地址为0.0.0.0，目的地址为255.255.255.255(发现报文)
    *   DHCP服务器收到**DHCP发现**信息后，广播**DHCP提供**信息，其中包括提供给DHCP客户机的IP地址，源地址为DHCP服务器地址，目的地址为255.255.255.255(提供报文)
    *   DHCP客户机收到**DHCP提供**信息后，如果接受该IP地址，那么就广播**DHCP请求**信息向DHCP服务器请求提供IP地址，源地址为0.0.0.0，目的地址为255.255.255.255(请求报文)
    *   DHCP服务器广播**DHCP确认**信息，将IP地址分配给DHCP客户机，源地址为DHCP服务器地址，目的地址为255.255.255.255(确认报文)
*   DHCP允许网络上配置多台DHCP服务器，当客户机发出**DHCP发现**信息时，有可能收到多个应答消息，通常选择最先到达的
*   分配的IP地址是临时的，这段时间称为租用期，租用期的数值应该由服务器自己决定，客户机也可以在报文中指明租用期的要求
*   DHCP是应用层协议，因为是通过**客户/服务器模式**工作的，其他层次的协议没有这两种工作方式



### ICMP协议

*   **网际控制报文协议(ICMP)：**让主机或路由器报告差错和异常情况，是网络层协议
*   ICMP报文作为IP数据报的数据，加上数据报的首部，组成IP数据报发送出去
*   ICMP报文分为：**ICMP差错报告报文**和**ICMP询问报文**
*   **ICMP差错报告报文**用于目标主机或到目标主机路径上的路由器向源主机报告差错和异常情况，包括5种常用的类型：
    *   **终点不可达：**当路由器或主机不能交付数据报时，就向源点发送终点不可达报文
    *   **源点抑制：**当路由器或主机由于**拥塞**而丢弃数据报时，就向源点发送源点抑制报文，使源点知道应当把数据报的发送速率放慢
    *   **时间超过：**当路由器收到生存时间(TTL)为零的数据报时，除丢弃该数据报外，还要向源点发送时间超过报文，当终点在预先时间内不能收到一个数据报的全部数据报片时，就把已收到的数据报片都丢弃，并向源点发送时间超过报文
    *   **参数问题：**当路由器或目的主机收到的数据包的首部中有的**字段的值不正确**时，就丢弃该数据报，并向源点发送参数问题报文
    *   **改变路由(重定向)：**路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器(可通过更好的路由)
*   不应发送ICMP差错报告报文的情况：
    *   对**ICMP差错报告报文**不再发送ICMP差错报告报文
    *   对**第一个分片的数据报片的所有后续数据报片**都不发送ICMP差错报告报文
    *   对**具有组播地址的数据报**都不发送ICMP差错控制报文
    *   对**具有特殊地址(如127.0.0.0或0.0.0.0)**的数据报不发送ICMP差错报告报文
*   ICMP询问报文有4种类型：
    *   回送请求和回答报文
    *   时间戳请求和回答报文
    *   地址掩码请求和回答报文
    *   路由器询问和通告报文
*   ICMP的两个常见应用：分组网间探测PING(用来测试两台主机之间的连通性)，Traceroute(用来追踪分组经过的路由)
*   PING使用了ICMP回送请求和回答报文，工作在应用层，直接使用网络层的ICMP，未使用传输层的TCP或UDP
*   Traceroute(Tracert)使用了ICMP时间超过报文，工作在网络层



### 习题

*   TCP，UDP是传输层协议，IP，ICMP，ARP，RARP(逆地址解析协议)是网络层协议

*   数据报被分片后，每个分片都将独立地传输到目的地，其间可能会经过不同的路径，而且在传输过程中仍然存在分片的可能(不同网络的MTU不同)，也不一定按序到达，所以最后在目的端主机分组才能被重组

*   如果数据报的大小超过MTU同时DF=1，则丢弃分组，并采用ICMP差错报文向源主机报告

*   D类IP地址属于组播地址

*   127.xx.xx.xx作为IP保留地址，用于回路测试

*   在整个传输过程中，IP数据报首部的源IP地址和目的IP地址都不发生变化

*   划分子网可以减少广播域的大小，提高IP地址的利用率，并不增加网络的数量

*   CIDR技术的作用是把**小的网络汇聚成大的超网**

*   每当路由器将IP数据报转发到一个具体的网络中时，都需要重新封装源硬件地址和目的硬件地址

*   NAT的表项**需要管理员添加，如果表中找不到则不进行转发**

*   ICMP报文作为IP层数据报的数据，加上IP数据报的首部，组成IP数据报发送出去

*   ICMP报文作为数据字段封装在IP分组中，因此IP直接为ICMP提供服务，UDP和TCP都是传输层协议，为应用层提供服务，PPP是数据链路层协议，为网络层提供服务

*   主机与路由器的端口的IP地址如果与主机的默认网关不同，则主机不能访问因特网，不同的网段之间必须通过路由器来进行通信

*   0.0.0.0可以作为本主机在本网络的源地址，但不能作为目的地址

*   127.x.x.x是回送地址，以它为目的IP地址的数据将被立即返回本机

*   分片中的**有效数据**的部分为8B的倍数，总长度中减去首部数据的长度就是**有效数据**

*   给定一个C类IP地址：192.168.161.0，要求分4个子网，每个子网主机数量为20-30台

    *   分配3位给子网，一共有8种可能，满足子网数量要求

    *   还有5位给主机，一共32种，去除全0和全1的，最多可分配30台，满足要求

    *   所以可分为：子网掩码为255.255.255.224(1110 0000)，前面3位为子网号

        | 部门       | 部门网络地址               | 主机IP地址范围                   |
        | ---------- | -------------------------- | -------------------------------- |
        | 工程技术部 | 192.168.161.32(0010 0000)  | 192.168.161.33——192.168.161.62   |
        | 市场部     | 192.168.161.64(0100 0000)  | 192.168.161.65——192.168.161.94   |
        | 财务部     | 192.168.161.96(0110 0000)  | 192.168.161.97——192.168.161.126  |
        | 办公室     | 192.168.161.128(1000 0000) | 192.168.161.129——192.168.161.158 |

*   将**131.128.56.0/24**分配为4个尽可能大的子网

    *   分配2位给子网，一共四种可能，满足要求

    *   还有6位给主机，一共64位，去除全0和全1的可能，还有62种

    *   所以可分为：子网掩码为：255.255.255.192(1100 0000)

        | 子网              | 子网掩码        | 地址范围                       |
        | ----------------- | --------------- | ------------------------------ |
        | 131.128.56.0/26   | 255.255.255.192 | 131.128.56.1——131.128.56.63    |
        | 131.128.56.64/26  | 255.255.255.192 | 131.128.56.65——131.128.56.127  |
        | 131.128.56.128/26 | 255.255.255.192 | 131.128.56.129——131.128.56.191 |
        | 131.128.56.192/26 | 255.255.255.192 | 131.128.56.193——131.128.56.254 |

*   分配网络前缀：四个局域网，LAN1连接到四个局域网，LAN2中91台主机，LAN3中150台主机，LAN4中3台主机，LAN5中15台主机

    *   该自治系统分配到的IP地址块为30.138.118.0/23，给出每个局域网的地址块

    *   注意一个路由器端口也要配置一个IP地址

        | LAN  | 主机数                  | 所需位数             | 地址块                                  |
        | ---- | ----------------------- | -------------------- | --------------------------------------- |
        | LAN2 | 91                      | 7位主机号，2位子网号 | 30.138.119.0/25(第24位和第25位为01)     |
        | LAN3 | 150                     | 8位主机号，1位子网号 | 30.138.118.0/24(第24位为0)              |
        | LAN4 | 3                       | 3位主机号，6位子网号 | 30.183.119.240/29(第24位即以后为111110) |
        | LAN5 | 15                      | 5位主机号，4位子网号 | 30.183.119.192/27(第24位即以后为1110)   |
        | LAN1 | 3个路由器和一个网关地址 | 3位主机号，6位子网号 | 30.138.119.232/29(第24位即以后为111101) |

*   如果路由器直接与目的网络相连则路由表中的下一跳IP地址不用填

*   如果目的网络是互联网，则目的网络的IP地址为0.0.0.0，子网掩码为0.0.0.0

*   IP规范规定，所有主机和网关至少能支持576B的分组长度

*   IP首部中的标志字段占3位，分别为保留位，DF位，MF位

*   如果数据报长度大于MTU且DF位=1，则表示不允许分片，此时路由器应该丢弃该分组，并用ICMP差错报文向源主机报告

*   路由器R1的路由表：

    | 目的网络IP地址                           | 子网掩码                            | 下一跳IP地址                              | 接口 |
    | ---------------------------------------- | ----------------------------------- | ----------------------------------------- | ---- |
    | 202.118.1.128(端口E1连接的局域网)        | 255.255.255.128                     | ——                                        | E1   |
    | 202.118.1.0(端口E2连接的局域网)          | 255.255.255.128                     | ——                                        | E2   |
    | 202.118.3.2(连接在另一个路由器上的A网络) | 255.255.255.255(保证目的IP地址一样) | 202.118.2.2(连接A网络的路由器的IP地址)    | L0   |
    | 0.0.0.0                                  | 0.0.0.0                             | 202.118.2.2(连接到互联网的路由器的IP地址) | L0   |

    



## IPv6

*   解决“IP地址耗尽”问题的措施有以下三种：
    *   采用无类别编制CIDR，使IP地址的分配更加合理
    *   采用网络地址转换(NAT)方法以节省全球IP地址
    *   采用具有更大地址空间的新版本的IPv6
*   前两种只是延长了IPv4地址分配完毕的时间，采用IPv6从根本上解决了IP地址的耗尽问题
*   **IPv6的特点：**
    *   更大的地址空间：IPv6将地址从IPv4的32位增大到了128位，IPv6的字节数(16B)是IPv4字节数(4B)的平方
    *   扩展的地址层次结构
    *   改进的选项
    *   允许协议继续扩充
    *   支持即插即用(即自动配置)
    *   支持资源的预分配
    *   IPv6只有在包的源结点才能分片，是端到端的，传输路径中的路由器不能分片，所以从一般意义上说，IPv6不允许分片(不允许IPv4的路由分片)
    *   IPv6首部长度必须是8B的整数倍，而IPv4的首部是4B的整数倍
    *   增大了安全性，身份验证和保密功能是IPv6的关键特征
*   IPv6与其他的因特网协议兼容，包括TCP，UDP，ICMP，IGMP，OSPF，BGP，DNS
*   IPv6相当好地满足了预定的目标，主要体现在：
    *   IPv6比IPv4长得多的地址，IPv6的地址有16个字节，是IPv4的$2^{96}$倍
    *   简化了IP分组头部字段，它包含8个域(IPv4是12个域)，这一改变使得路由器能够更快地处理分组，从而可以改善吞吐率
    *   更好地支持选项，从前一些必选的段变成了可选段，表示选项的方式的改变还能加快分组的处理速度



*   IPv6的数据报的目的地址可以是以下三种基本类型地址之一：
    *   单播，也就是传统的点对点通信
    *   多播，是一点对多点的通信，分组被交付到一组计算机的每台计算机
    *   任播，IPv6增加的一种类型，任播的目的站是**一组计算机**，但数据报在交付时只交付**其中一台计算机**，通常是距离最近的
*   IPv4地址通常采用**点分十进制表示法**，IPv6地址采用将每4位用一个十六进制数表示，并用冒号分隔每16位
*   IPv6地址采用一些方式使地址更紧凑，比如4BF5:0000:0000:0000:BA5F:039A:000A:2176
    *   当有多个“0”时进行缩写但每16中必须有一位数，则：4BF5:0:0:0:BA5F:39A:A:2176
    *   当有连续的“0”时用双冒号进行省略，则：4BF5::BA5F:39A:A:2176
*   IPv6扩展了IPv4地址的分级概念，使用三个等级：
    *   第一级(顶级)指明全球都知道的公共拓扑
    *   第二级(场点级)指明单个场点
    *   第三级指明单个网络接口
*   IPv6地址采用多级体系主要是为了**使路由器能够更快地查找路由**
*   从IPv4向IPv6过渡有**双协议栈**和**隧道技术**两种策略
    *   双协议栈：指在一台设备上同时装有IPv4和IPv6协议栈，所以这台设备既能和IPv4网络通信也能和IPv6网络通信
        *   如果是路由器：那么在路由器的不同接口上分别配置了IPv4地址和IPv6地址，并很可能分别连接了IPv4网络和IPv6网络
        *   如果是计算机：那么将同时拥有IPv4地址和IPv6地址，并具备同时处理这两个协议地址的功能
    *   隧道技术：在IPv6数据报要进入IPv4网络时，把整个IPv6数据报封装到IPv4数据报的数据部分，使得IPv6数据报就好像在IPv4网络的隧道中传输



### 习题

*   IPv6减少了头部字段数目，仅包含8个字段
*   IPv6支持Qos，以满足实时，多媒体通信的需要
*   由于目前网络传输介质的可靠性较高，出现比特错误的可能性很低，且数据链路层和传输层有自己的校验，所以IPv6没有校验和字段
*   IPv6的首部长度是固定的，不需要首部长度字段，IPv6取消了校验和字段，加快了路由器处理数据报的速度



## 路由协议

*   **自治系统(AS)：**单一技术管理下的一组路由器，这些路由器使用一种AS内部的路由选择协议和共同的度量来确定分组在该AS内的路由，同时还使用一种AS之间的路由选择协议来确定分组在AS之间的路由
*   一个自治系统内的所有网络都由一个行政单位来管理，一个自治系统的所有路由器在本自治系统内都必须是连通的
*   自治系统内部的路由选择称为**域内路由选择**，自治系统之间的路由选择称为**域间路由选择**

*   路由选择协议分为：
    *   **内部网关协议(IGP)**：一个自治系统内部使用的路由选择协议，每个自治系统的IGP可能不一样，如RIP，OSPF
    *   **外部网关协议(EGP)**：不同自治系统间传输信息，如果两个自治系统之间的IGP协议不一样，那么需要一种协议将路由选择信息传递到另一个自治系统中，如BGP-4



### 路由信息协议(RIP)

*   RIP是一种分布式的基于距离向量的路由选择协议，最大优点是简单
*   **RIP规定：**
    *   网络中的每个路由器都要维护从它自身到每个目的网络的距离
    *   距离也称跳数，从一个路由器直接连接目的网络跳数为1，每经过一个路由器跳数加1
    *   RIP认为好的路由器的距离最短
    *   允许一条路径跳数最大为15，超过15称为网络不可达，只适用于小型互联网，防止数据报不断循环在环路上，减少网络拥塞
    *   在任意两个使用RIP的路由器之间每30秒广播一次RIP路由更新信息，以便自动建立并维护路由表
    *   在RIP中不支持子网掩码的RIP广播，所有RIP中每个网络的子网掩码都一样，RIP2中支持变长子网掩码和CIDR
*   **RIP特点：**
    *   仅与相邻路由器交换信息
    *   路由器交换的信息是路由表
    *   按固定的时间间隔交换路由信息，如30秒
*   RIP依靠**距离向量算法**实现每个路由器中的路由表记录对每个目的网络的最短距离
*   **RIP优点：**实现简单，开销小，收敛过程较快
*   **RIP缺点：**
    *   限制了网络的规模，能使用的最大距离为15
    *   路由器之间交换的是路由表，因此网络规模越大，开销越大
    *   网络出现故障时，出现“慢收敛”的现象(即需要较长时间才能将此信息传送到所有路由器)，俗称“坏消息传得慢”，更新过程的收敛时间长
*   RIP是应用层协议，使用UDP传送数据(端口520)，RIP选择的路径不一定是时间最短的，但一定是具有最小路由器的路径



### 开放最短路径优先协议(OSPF)

*   开始最短路径优先协议是使用分布式链路状态路由算法，是IGP的一种
*   OSPF与RIP的区别：
    *   OSPF向本自治系统中的所有网络发送信息，使用**洪泛法**，而RIP仅向相邻路由器发送
    *   发送的信息是本路由器相邻的所有路由器的**链路状态**，也就是说只知道部分信息，而RIP知道所有网络信息
    *   只有当链路状态发生变化时，路由器才采用洪泛法向所有路由器发送此信息，并且更新过程收敛快，而RIP需要定期发送
    *   OSPF是网络层协议，不使用UDP或TCP，而是直接使用IP数据报发送(其IP数据报首部的协议字段为89)，而RIP是应用层协议，在传输层使用UDP
*   OSPF的其他特点：
    *   OSPF对不同的链路可根据IP分组的不同服务类型(TOS)而设置成不同代价，因此OSPF对于不同类型的业务可计算出不同的路由
    *   如果到同一个目的网络有多条相同代价的路径，那么可以将通信量分配给这几条路径，称为**多路径间的负载平衡**
    *   所有在OSPF路由器之间交换的分组都具有鉴别能力，因此保证了仅在可信赖的路由器之间交换链路状态信息
    *   支持可变长度的子网划分和无分类编址CIDR
    *   每个链路状态都带上一个32位的序号，序号越大，状态就越新
*   OSPF的基本工作原理：
    *   由于各路由器之间频繁地交换链路状态信息，因此所有路由器最终都能建立一个**链路状态数据库**，实际上就是全网的拓扑结构图，在全网范围内是一致的(称为链路状态数据库的同步)，然后每个路由器根据这个全网拓扑结构图，使用Dijkstra最短路径算法计算总自己到各目的网络的最优路径，但路由表中不会存储完整的路径，只存储“下一跳”路由器
*   为了使OSPF用于规模很大的网络，OSPF将一个自治系统再划分为若干更小的范围，称为**区域**，好处为：将利用洪泛法交换链路状态信息的范围局限于每个局域而非整个自治系统，减少了整个网络上的通信量，在一个区域内部的路由器只知道本区域的拓扑结构，处在上层的域称为**主干区域**，负责连通其他下层区域，并且还连接其他自治域

*   OSPF共有五种分组类型：
    *   问候分组：用来发现和维持邻站的可达性
    *   数据库描述分组：向邻站给出自己的链路状态数据库中的所有链路状态项目的摘要信息
    *   链路状态请求分组：向对方请求发送某些链路状态项目的详细信息
    *   链路状态更新分组：用洪泛法对全网更新链路状态
    *   链路状态确认分组：对链路更新分组的确认
*   每隔10秒，每两个相邻路由器要交换一次**问候分组**，以便知道哪些站可达
*   路由器使用**链路状态请求分组**向对方请求发送自己所缺少的某些链路状态项目的详细信息
*   一个路由器的链路状态发生改变，该路由器就使用**链路状态更新分组**用洪泛法发送，其他路由器在更新后，发送**链路状态确认分组**对更新分组进行确认
*   为了确保链路状态数据库与全网的状态保持一致，OSPF还规定每隔一段时间(如30分钟)就刷新一次数据库中的链路状态
*   **用UDP传送：**指将该信息作为UDP报文的数据部分
*   **用IP数据报传送：**指将该信息直接作为IP数据报的数据部分



### 边界网关协议(BGP)

*   边界网关协议(BGP)是不同自治系统的路由器之间交换路由信息的协议，是一种外部网关协议，常用于互联网的网关之间
*   BGP只能力求寻找一条能够到达目的网络且比较好的网络，而非寻找一条最佳路由
*   BGP采用**路径向量路由选择协议**，是应用层协议，基于TCP
*   工作原理：每个自治系统选择至少一个路由器作为该自治系统的“BGP发言人”，各BGP发言人之间通过TCP传送BGP报文，，所以BGP发言人除了运行BGP外还要运行该AS所用的内部网关协议，**BGP所交换的网络可达信息就是要到达某个网络(用网络前缀表示)所要经过的一系列AS**
*   **BGP的特点：**
    *   BGP交换路由信息的结点数量级是自治系统的数量级，比这些自治系统中的网络数少很多
    *   每个自治系统中BGP发言人(或边界路由器)的数目是很少的，这样使自治系统之间的路由选择不至于过分复杂
    *   BGP支持CIDR，因此BGP的路由表包括目的网络前缀，下一跳路由器，到达该网络所要经过的各个自治系统序列
    *   在BGP刚运行时，BGP的邻站交换整个BGP路由表，但以后只需在发生变化时更新有变化的部分
*   BGP-4共使用4种报文：
    *   打开报文(Open)：用来与相邻的另一个BGP发言人建立关系
    *   更新报文(Update)：用来发送某一路由的信息，以及列出要撤销的多条路由
    *   保活报文(Keepalive)：用来确认打开报文并周期性地证实邻站关系
    *   通知报文(Notification)：用来发送检测到的差错

​	

### 习题

*   采用分层次划分区域的方法虽然使交换信息的种类增加了，同时也使OSPD协议更加复杂了，但这样使每个区域内部交换信息的通信量大大减少，进而使OSPF协议能够用于规模很大的自治系统中
*   **收敛：**当路由环境发生变化后，各路由器调整自己的路由表以适应网络拓扑结构的变化，最终达到稳定状态，收敛越快，路由器就越快适应网络拓扑结构的变化
*   主干区域中，用于连接主干区域和其他下层区域的路由器称为**区域边界路由器**，主要是在主干区域中的路由器，就都称为**主干路由器**，主干路由器能够兼作区域边界路由器
*   BGP交换的路由信息是到达某个目的网络所要经过的各个自治系统序列



## IP组播

*   组播机制：让源计算机一次发送的分组能够抵达用一个组地址标识的若干目标主机，并被他们正确接收
*   组播一定应用于**UDP**，而TCP是一个面向连接的协议
*   IPv4中，组播地址在D类地址空间中分配，IPv6也有一部分地址空间保留给组播组
*   主机使用一个称为**IGMP(因特网组管理协议)**的协议加入组播组
*   通过**扩展路由器**的路由选择和转发功能在许多路由器互联的支持硬件组播的网络上面实现因特网组播
*   主机组播只发送一份数据，只有数据在传送路径出现分岔时才将分组复制后继续转发
*   组播需要路由器的支持才能实现，能够运行组播协议的路由器称为**组播路由器**



### IP组播地址

*   IP组播使用D类地址格式，D类地址前四位为1110，所以范围为224.0.0.0——239.255.255.255，每个D类IP地址标志一个组播组
*   组播数据报的特点：
    *   使用D类IP地址作为目的地址，并且首部中的协议字段值为2，表明使用IGMP
    *   组播数据报和普通IP数据报一样，不提供可靠交付
    *   组播地址只能用于目的地址，不能用于源地址
    *   对组播数据报不产生ICMP差错报文，所以在PING命令后面键入组播地址，将不会收到响应
    *   并非所有的D类地址都能作为组播地址
*   IP组播分为：
    *   在本局域网上进行硬件组播
    *   在因特网的范围内进行组播
*   D类组播地址中共有28位，前5位不能构成以太网的硬件地址，后23位作为组播映射到MAC地址中，所以映射关系不是唯一的，收到组播数据报的主机还要在IP层利用软件进行过滤，把不是本主机要接受的数据丢弃



### IGMP与组播路由算法

*   IGMP：因特网组管理协议，让连接到本地局域网上的组播路由器知道本局域网上是否有主机参加或退出了某个组播组
*   IGMP工作分为2个阶段：
    *   当某台主机加入新的组播组时，该主机应向组播组的组播地址发送一个IGMP报文，声明自己要成为该组的成员，本地的组播路由器收到IGMP报文后，将组成员关系转发给因特网上的其他组播路由器
    *   因为组成员关系是动态的，本地组播路由器要周期性地探询本地局域网上的主机，某个组的主机有响应则认为这个组是活跃的，如果一个组中的主机多次探询没有反应则不再将该组的成员关系转发给其他的组播路由器
*   在许多由路由器互联的支持硬件多点传送的网络上实现因特网组播时，有三种路由算法：
    *   基于链路状态的路由选择
    *   基于距离-向量的路由选择
    *   建立在任何路由器协议之上，称为协议无关的组播(PIM)
*   在设计组播路由时
    *   构造组播转发树，来避免路由环路
    *   采用水平分割，来避免距离-向量路由算法中的无穷计数问题
    *   采用TTL字段，来防止IP分组由于环路而在网络中无限循环
*   因特网的组播是靠路由器来实现的，这些路由器必须增加一些能够识别组播的软件，能够运行组播协议的路由器可以是一个单独的路由器，也可以是运行组播软件的普通路由器，因特网上的组播比以太网上的组播复杂得多，因为以太网本身支持广播和组播，而因特网上当前的路由器和许多物理网络都不支持广播和组播



## 移动IP

*   **移动IP技术：**指移动站以固定的网络IP地址实现跨越不同网段的漫游功能，并保证基于网络IP的网络权限在漫游过程中不发生改变
*   移动站：把其连接点从一个网络或子网改变到另一个网络或子网的主机
*   移动IP定义了三种功能实体：**移动节点，本地代理(归属代理)，外地代理**
    *   移动节点：具有永久IP地址的移动站(主机)
    *   本地代理：连接在归属网络(原始连接到的网络)上的路由器(家里的管家)
    *   外地代理：连接在被访网络(移动到另一地点所接入的网络)上的路由器(酒店的管家)
*   如果需要在移动中使用TCP传输，我们就需要保持TCP一直连接，所以我们需要在移动时主机的IP地址保持不变，需要用到移动IP



### 移动IP通信过程

*   **永久地址(归属地址)：**移动站的原始地址
*   **归属网络：**移动站原始连接的网络
*   **被访网络：**当移动站移动到另一地点所接入的外地网络
*   **外地代理：**被访网络中使用的代理(被访网络的路由器)
    *   为移动站创建一个临时地址，称为**转交地址**，转交地址的网络号和被访网络的网络号一样，作为一个中间桥梁
    *   及时把移动站的转交地址告诉其归属代理
*   基本通信流程：
    *   移动站在归属网络中时，按传统的TCP/IP方式进行通信
    *   移动站漫游到外地网络时，向外地代理进行登记，获得一个临时的转交地址，外地代理要向移动站的归属代理登记移动站的转交地址
    *   归属代理知道移动站的转交地址后，构建一条通向转交地址的隧道，将截获的发送给移动站的IP分组进行再封装，并通过隧道发送给被访网络的外地代理
    *   外地接收到归属代理发送的数据报，进行拆封，恢复成原始的IP分组，然后发送给移动站，这样移动站就在被访网络中也能接收到发送给它的IP分组
    *   移动站在被访网络中对外发送数据时，仍然使用自己的永久地址作为数据报的源地址，直接通过被访网络的外部代理进行转发
    *   移动站又移动到另一个外地网络时，在新外地代理登记后，然后新外地代理将移动站的转交地址告诉其归属代理，进行转交地址的覆盖，重新构建新隧道
    *   移动站回到归属网络中时，移动站向归属代理注销转交地址
*   移动IP的基本工作过程可以分为：代理发现，注册，分组路由，注销
*   移动IP的分组可以分为单播，广播，组播



## 网络层设备

### 冲突域与广播域

*   冲突域：连接到同一物理介质上的所有结点的集合，这些结点之间存在介质争用的现象，集线器，中继器连接的结点都属于同一个冲突域，所以集线器，中继器不能划分冲突域
*   广播域：指接收同样广播消息的结点集合，第一层的集线器，第二层的交换机所连接的结点都属于一个广播域
*   局域网(LAN)特指使用路由器分割的网络，也就是广播域



### 路由器的组成和功能

*   路由器：一种具有多个输入/输出的专用计算机，任务是连接不同的网络(连接异构网络)并完成路由转发
*   在多个逻辑网络(即多个广播域)互联时必须使用路由器
*   直接交付：源地址与目的地址在同一个网络中，无须通过路由器直接传输
*   间接交付：源地址与目的地址不在同一个网络中，路由器按照转发表指出的路由将数据报转发给下一个路由器
*   从结构上看，路由器分为：
    *   **路由选择**，也称**控制部分**，核心构件是**路由选择处理机**
        *   路由选择处理机根据所选定的路由选择协议构造路由表，同时经常或定期地和相邻路由器交换路由信息而不断更新和维护路由表
    *   **分组转发**，由三部分组成：
        *   交换结构：路由器的关键部件，根据转发表对分组进行处理，将某个输入端口进入的分组从一个合适的输出端口转发出去
        *   输入端口：从物理层接收到的比特流中提取出数据链路层帧，进而从帧中提取出网络层数据报
        *   输出端口：输入端口的逆操作，将网络层数据报封装成帧，再通过比特流的形式传送到物理层
*   从模型的角度上来看，路由器是网络层设备，实现了网络模型的下三层，即物理层，数据链路层，网络层

*   有三种常用的交换方法：
    *   通过存储器进行交换
    *   通过总线进行交换
    *   通过互联网络进行交换

*   路由器主要完成两个功能：
    *   分组转发
        *   处理通过路由器的数据流，关键操作是转发表查询，转发及相关的队列管理和队列调度
    *   路由计算
        *   通过与其他路由器进行基于路由协议的交互，完成路由表的计算
*   路由器与网桥的重要区别：
    *   网桥与高层协议无关，路由器是面向协议的，依据网络地址进行操作，并进行路径选择，分段，帧格式转换，对数据报的生存时间和流量进行控制，现在的路由器都提供多种协议的支持，如OSI，TCP/IP，IPX



### 路由表和路由转发

*   路由表是根据路由选择算法得出的，主要作用是路由选择
*   路由表中包含：目的网络IP地址，子网掩码，下一跳IP地址，接口
*   转发表是从路由表中得出的，其表项和路由表项有直接的对应关系
*   转发表的格式应使查找过程最优化，路由表的格式应对网络拓扑变化的计算最优化
*   转发表中包含：一个分组将要发往的目的地址，分组的下一跳(实际为MAC地址)
*   为了减少转发表的重复项目，可以使用一个默认路由代替所有具有相同“下一跳”的项目，并将优先级设为最低
*   路由表总是由软件来实现，而转发表可以用软件实现，也可以用特殊的硬件实现
*   分组的直接转发是靠直接查找转发表，而不是直接查找路由表



### 习题

*   路由器只能根据IP地址进行转发
*   直接交付在同一网段内，因此不涉及路由器
*   路由器的路由选择部分包含：
    *   路由选择处理机：根据所选定的路由选择协议构造路由表，同时和相邻路由器交换路由信息
    *   路由选择协议：用来更新路由表的算法
    *   路由表：根据路由算法得出，一般包括从目的网络到下一跳的映射
*   路由表中**默认路由**的目的地址和子网掩码都是0.0.0.0
*   **不同局域网中的主机H1(202.99.98.18)向主机H2(202.99.98.35)发送IP数据包的过程：**
    *   主机H1首先构造一个源IP地址为202.99.98.18，目的地址为202.99.98.35的IP数据报，主机H1先把本子网的子网掩码与H2的IP地址进行逐位相与，所得结果不等于H1的网络地址，因此H1和H2不在同一网段，无法进行直接交付，然后将该数据报传送给数据链路层
    *   主机H1通过ARP获得路由器R1(202.99.98.17)对应的MAC地址(默认网关的MAC地址)，并将其作为目的MAC地址，将H1的MAC地址作为元MAC地址填入封装有IP数据报的帧，然后将该帧发送出去
    *   路由器R1收到该帧后，去掉帧头和帧尾，得到IP数据报，然后根据IP数据报中的目的IP地址(202.99.98.35)去查找路由表，得到下一跳地址为直接相连
    *   路由器R1通过ARP得到主机H2的MAC地址，并将其作为目的MAC地址，将R1的MAC地址作为源MAC地址填入封装有IP数据报的帧，然后将该帧发送到H2所处的子网上
    *   主机H2将收到的帧，去除帧头和帧尾，并最终得到从主机H1发来的IP数据报
*   解题：
    *   先观察两个主机的IP地址是否可以使用一个网络前缀组合成一个子网LAN，比如192.168.1.2/26和192.168.1.3/26的网络前缀为192.168.1.0，可以视为一个局域网，用以太网交换机连接起来，再使用路由器将不同子网连接起来
    *   路由器的接口需要配置IP地址，两个路由器之间的链路属于一个子网，比如R1的A接口与R2的B接口相连，R1的A接口的IP地址为192.168.1.253/30，那么R2的B接口的IP地址的前缀也为192.168.1.111111__ __，观察253为11111101，除去全0和全1，所以R2的B接口为254
    *   通常一个子网的**默认网关地址**就是连接这个子网的路由器端口的IP地址
    *   注意观察主机的IP地址的类别，如果是C类192.168.0.0——192.168.255.255，那么就是私有IP地址，如果需要访问Internet，路由器需要提供NAT服务，即网络地址转换服务
    *   注意如果目的地址中主机号全为1，则为本网络的广播地址



## 疑点

*   **尽最大努力交付**的方面：
    *   不保证源主机发送的IP数据报一定无差错地交付到目的主机
    *   不保证源主机发送的IP数据报都在某一规定时间内交付到目的主机
    *   不保证源主机发送到IP数据报一定按发送时的顺序交付到目的主机
    *   不保证源主机发送的IP数据报不会重复交付到目的主机
    *   不故意丢弃IP数据报，除非路由器检测到首部校验和有错误，或网络中通信量过大，路由器或目的主机中的缓存已无空闲空间
*   路由器的重要功能就是能够连接异构网络，如果很多相同类型的网络相连，可以使用交换机来连接
*   IP数据报具有分片的功能，但广域网中的分组则不必分片，因为广域网能够通过的分组的最大长度是该广域网中的所有结点都知道，超过最大长度的分组不会发送
*   在接受广播帧时，主机通过适配器(网络接口卡NIC)接收，然后传递给操作系统，CPU执行协议软件，并界定是否接收和处理该帧
*   在接受组播帧时，适配器根据特定的组播地址表来接收帧，不是由CPU决定



![网络层](/Users/coffeeboy/Desktop/考研/assets/网络层-9270180.jpg)





# 传输层

*   传输层向它上面的应用层提供通信服务，属于面向通信部分的最高层，也是用户功能中的最低层
*   传输层为**运行在不同主机上的进程之间提供逻辑通信**，网络层为**主机之间提供逻辑通信**
*   即使网络层不可靠(网络层协议使分组丢失，混乱或重复)，传输层同样为应用程序提供可靠的服务



## 传输层的功能

*   传输层提供不同主机上的应用程序之间的逻辑通信(即端到端的通信)
    *   逻辑通信：传输层之间的通信好像是沿水平方向传送数据，但事实上这两个传输层之间并没有一条水平方向的物理连接
*   复用和分用
    *   **复用：**指发送方**不同的应用进程**都可使用**同一个传输层协议**传送数据
    *   **分用：**指接收方的传输层在**剥去报文的首部后能够把这些数据正确地交付到目的应用进程**
    *   网络层也有复用和分用功能
        *   网络层复用：指发送方**不同协议的数据**都可以**封装成IP数据报**发送出去
        *   网络层分用：指接收方的网络层在**剥去首部后把数据交付给相应的协议**

*   传输层还能对收到的报文进行**差错控制(首部和数据部分)**
    *   网络层只检查IP数据报的首部
*   **传输层同时提供两种不同的传输协议：面向连接的TCP和无连接的UDP**
    *   网络层要么提供面向连接的服务，如虚电路，要么提供无连接服务，如数据报



## 传输层的端口

*   **端口的作用：**让应用层的各种应用进程将其数据**通过端口**向下交付给传输层，让传输层知道应当将其报文段中的数据向上通过**端口**交付给应用层相应的进程

*   端口是传输层服务访问点(TSAP)，标识的是主机中的应用进程，相当于网络层的IP地址

*   数据链路层的SAP是MAC地址，网络层的SAP是IP地址，传输层的SAP是端口

*   **端口号：**

    *   端口号标识应用进程

    *   端口号长度为16bit，能够表示65535个端口，根据端口范围可分为：服务器端使用的端口号，客户端使用的端口号

        *   服务器端使用的端口号：

            *   熟知端口号，0-1023，IANA(互联网地址指派机构)，把这些端口指派给TCP/IP最重要的一些应用程序，比如：

                | 应用程序   | FTP  | TELNET | SMTP | DNS  | TFTP | HTTP | SNMP |
                | ---------- | ---- | ------ | ---- | ---- | ---- | ---- | ---- |
                | 熟知端口号 | 21   | 23     | 25   | 53   | 69   | 80   | 161  |

            *   登记端口号，1024-49151，给不是熟知端口号的应用程序使用

        *   客户端使用的端口号：49152-65535，只在客户进程运行时才动态地选择，又称短暂端口号/临时端口，通信结束就不复存在

*   **套接字：**

    *   套接字Socket：端口号拼接到IP地址
    *   套接字Socket=(IP地址：端口号)，唯一地标识网络中的一台主机和其上的一个应用进程

*   **服务：**

    *   传输层提供的服务有：面向连接的TCP服务，无连接的UDP服务
    *   **TCP：**
        *   在通信双方进行通信之前，必须先建立连接，在整个通信过程中，整个连接的情况一直被实时地监控和管理，通信结束后释放连接
        *   提供的是一条全双工的可靠逻辑信道
        *   不提供广播或组播的服务
        *   增加了许多开销，如：确认，流量控制，计时器，连接管理，使协议数据单元的头部增加很多，占用许多的处理机资源
        *   主要适用于可靠性更重要的场合，如文件传输协议(FTP)，超文本传输协议(HTTP)，远程登录(TELNET)
    *   **UDP：**
        *   指两个实体之间的通信不需要先建立好连接，需要通信时，直接将信息发送到“网络”中，让该信息的传递在网上尽力而为地往目的地传送
        *   提供的是一条不可靠的逻辑信道
        *   在IP之上只提供两个附加服务：多路复用和对数据的错误检查
        *   执行速度比较快，实时性好
        *   使用UDP的应用主要有：小文件传送协议(TFTP)，DNS，SNMP和实时传输协议(RTP)

*   面向连接的服务可以保证数据的可靠和顺序交付

*   可靠的协议中的“可靠”指的是一个协议使用确认机制对传输的数据进行确认

*   端口号只标识本计算机应用层中的各个进程，且同一个计算机中TCP和UDP分别拥有自己的端口号， 可以共存于同一台主机





## UDP

*   UDP仅在IP
*   数据报的服务上提供两个基本的服务：复用和分用，差错控制
*   UDP的优点：
    *   **UDP无须建立连接**
        *   不会引入建立连接的时延
    *   **不维护连接状态**
        *   TCP在端系统中维护连接状态，此连接状态包括接收和发送缓存，拥塞控制参数，序号与确认号的参数
        *   UDP不维护，所以都能支持更多的活动客户机
    *   **分部首部开销小**
        *   TCP有20B的首部开销，UDP只有8B的首部开销
    *   **应用层能够更好地控制要发送的数据和发送的时间**
        *   UDP没有拥塞控制，不会影响主机的发送效率，UDP能够慢走某些实时应用以稳定的速度发送，能容忍一些数据的丢失，但不允许有较大的时延的需求
    *   **UDP支持一对一，一对多，多对一的交互通信**
*   UDP的应用：
    *   一次性传输较少数据的网络应用，如DNS，SNMP
    *   多媒体应用，如IP电话，实时视频会议，流媒体
*   UDP不保证可靠交付，所有维护可靠性的工作可由用户在应用层来完成，应用开发者可根据应用的需求来灵活设计自己的可靠性机制
*   UDP是面向报文的，UDP对应用层的报文，添加首部后就交付给IP层，对IP层的UDP数据报，在去除首部后就交付给上层应用程序



### UDP的首部格式

*   UDP数据报包括：UDP首部和用户数据，UDP首部有8B，由4个2B的字段组成：
    *   源端口，需要对方回信时使用，不需要时可全为0
    *   目的端口，在终点交付报文时必须用到
    *   长度，UDP数据报的长度，最短为8B
    *   校验和，校验首部和数据，有错就丢弃
*   如果接收方UDP发现目的端口号不正确，就丢弃报文，并由ICMP发送“端口不可达”差错报文给发送方



### UDP校验

*   UDP校验和检查首部和数据，IP校验和只检查首部

*   UDP数据报包括首部和数据部分，首部有8B，由4个字段组成：

    *   源端口

    *   目的端口

    *   长度，包含首部和数据，最小为8B，仅有首部
    *   校验和，校验首部和数据，有错就丢弃

*   UDP伪首部包含：

    *   4B源IP地址

    *   4B目的IP地址

    *   1B的全0

    *   1B的协议字段，UDP中为17

    *   2B的UDP长度

        ![这里写图片描述](/Users/coffeeboy/Desktop/考研/assets/20160318110857394-9511779.png)

*   校验过程：

    *   先把全0放入校验和字段并添加伪首部，如果UDP数据报的数据部分不是偶数个字节，就在后面添加一个全0字节

    *   按二进制反码计算出这16个字节的和，将此和的二进制反码写入校验和字段中

    *   去掉伪首部和添加的字节(如果有)，发送

    *   接收方接收到UDP数据报，加上伪首部和全0字节(如果是数据是偶数个)

    *   按二进制反码求和，如果结果为全1，则无错

    *   如果结果中出现了0，则代表出错，丢弃或者交付给上层之后附上错误报告，告诉上层这是错误的数据报

        ![在这里插入图片描述](/Users/coffeeboy/Desktop/考研/assets/UDP校验.png)

*   这种简单的差错校验方法的校验能力并不强，好处是简单，处理速度快



### 习题

*   UDP没有流量控制
*   UDP的校验和不是必须的，可以不使用，将校验和字段设置为全0，如果校验和的计算结果恰好是0，则将校验和字段置为全1
*   远程登录需要一个客户端到服务端的可靠连接，使用UDP不合适，客户/服务器模式，远程调用，实时多媒体应用适合UDP
*   为什么使用UDP而不直接使用IP？
    *   IP分组包含IP地址，只指定目的主机，不能指定目的应用进程，UDP分组包含目的端口，能够制指定一个应用进程，此外，UDP还能对数据报的数据段进行差错检测
*   TCP有重传机制，传输可靠，UDP不保证可靠递交，没有重传机制，比TCP的开销小很多，实时性好





## TCP

*   TCP是在不可靠的IP层之上实现的可靠的数据传输协议，主要解决**传输的可靠，有序，无丢失，不重复问题**



### TCP的特点

*   TCP是面向连接的传输层协议，TCP连接的是一条逻辑连接
*   TCP连接是点对点的(一对一的)，每一条TCP连接只能有2个端点
*   TCP提供可靠交付的服务，保证传送的数据无差错，不丢失，不重复，有序
*   TCP提供全双工通信，允许通信双方的应用进程随时发送数据，两端都设有**发送缓存和接收缓存**
    *   发送缓存：
        *   存放发送应用程序传送给发送方TCP准备发送的数据
        *   存放TCP已发送但尚未收到确认的数据
    *   接收缓存：
        *   存放按序到达但尚未被接受应用程序读取的数据
        *   不按序到达的数据
*   TCP是面向字节流的，即TCP传送时是逐个字节发送的，但是应用程序与TCP的交互是一次一个数据块(大小不等)
*   TCP报文的长度根据接收方给出的窗口值和当前网络的拥塞程度决定
    *   如果应用进程传送到TCP缓存的数据块太长，TCP就把它划分为短一点再传送
    *   如果数据块太短，TCP可以等到积累足够多的字节后再构成报文段发送出去



### TCP报文段

*   TCP传输的数据单元称为报文段，可以用来运载数据，建立连接，释放连接和应答

*   TCP报文段分为首部和数据，首部最短为20B，后面有4N个字节作为选择项，长度为4B的整数倍

*   整个TCP报文段作为IP数据报的数据部分封装在IP数据x报中

    ![9rzlJf](/Users/coffeeboy/Desktop/考研/assets/9rzlJf-4831d39dd3908d461b25a324be57aa52-9512782.png)

    *   源端口和目的端口，各2B，端口是传输层和应用层的服务接口
    *   序号，占4B，TCP是逐个字节发送的，每个字节都有序号，该序号标识第一个数据字节的序号(不包括首部，指应用层传送的数据)，一报文段的序号字段为301，携带的数据有100B，那么最后一个字节的序号就是400，下一个数据报的序号字段为401
    *   确认号，占4B，是期望收到对方下一个报文段的第一个数据字节的序号，采用累计确认，A发送给B的TCP数据报中序号字段为501，数据长度为200B，如果B已正确收到这个报文段，那么B发送给A的确认报文段中把**确认号**置为701
    *   数据偏移(即首部长度)，占1B(即4位)，单位为4B，最大为15，所以最大首部长度为60B
    *   保留，占6位，全置为0
    *   紧急位URG，当URG=1，表示紧急指针字段有效，从数据的第一个字节到紧急指针所指字节就是紧急数据，需要尽快传送
    *   确认位ACK，当ACK=1，表示确认字段有效，TCP规定，在建立连接之后所有传送的报文段都必须把ACK置1
    *   推送位PSH(push)，当PSH=1，表示该报文段应尽快交付给接收应用程序，而不再等到整个缓存都填满后再交付
    *   复位位RST(Reset)，当RST=1，表示TCP连接中出现严重差错，必须释放连接，然后再重新建立运输连接
    *   同步位SYN，当SYN=1，表示这是一个连接请求或连接接受报文
        *   SYN=1，ACK=0，表示这是连接请求报文
        *   SYN=1，ACK=1，表示这是同意建立连接响应报文
    *   终止位FIN(Finish)，当FIN=1，表示数据发送完毕，释放连接
    *   窗口，占2B，指允许对方发送的数据量，接收方的数据缓存空间是有限的，用窗口值作为接收方让发送方设置其发送窗口的依据
    *   校验和，占2B，校验范围包括首部和数据，计算校验和时和UDP一样，不过将**伪首部中的协议字段从17改为6**，UDP长度改为TCP长度
    *   紧急指针，占2B，仅在URG=1时才有意义，指出本报文段中紧急数据共有多少字节，紧急数据在报文段数据最前面
    *   选项，长度可变，TCP最初规定了一种选项，即最大报文长度(MSS)，MSS是TCP报文段中的数据字段的最大长度
    *   填充，为了使整个首部长度是4B的整数倍



### TCP连接管理

*   TCP是面向连接的协议，每个TCP连接都有三个阶段：连接建立，数据传送，连接释放
*   TCP连接管理就是使运输连接的建立和释放都能正常进行
*   TCP建立连接的过程中，需要解决下面三个问题：
    *   要使每一方都能确知对方的存在
    *   要允许双方协商一些参数(如窗口最大值，是否使用窗口扩大选项，时间戳选项，服务质量)
    *   能够对运输实体资源进行分配，比如缓存大小，连接表中的项目
*   每条TCP连接都有2个端点，但是该端点不是主机，应用进程，IP地址，传输层的协议端口，而是**套接字**
*   TCP连接的建立采用**客户/服务器模式**，主动发起连接建立的应用进程称为**客户**，被动等待连接建立的应用进程称为**服务器**



*   TCP连接的建立，主要有三个步骤，称为**三次握手**
    *   连接建立前，服务器进程处于LISTEN(收听)状态，等待客户的连接请求
    *   第一步：客户机的TCP首先向服务器的TCP发送**连接请求报文段**
        *   这个报文段首部中同步位SYN置1，选择一个初始序号seq=x
        *   SYN报文段不能携带数据，但消耗一个序号
        *   TCP客户进程进入SYN-SENT(同步已发送)状态
    *   第二步：服务器的TCP收到连接请求报文段后，如同意建立连接，则向客户机发回确认，并为该TCP连接**分配缓存和变量**
        *   这个确认报文段中，SYN和ACK都置1，确认号ack=x+1，同时选择一个初始序号seq=y
        *   该报文段不能携带数据，但消耗一个序号
        *   TCP服务器进程进入SYN-RCVD(同步收到)状态
    *   第三步：客户机收到确认报文段后，还要向服务器给出确认，并为该TCP连接**分配缓存和变量**
        *   这个确认报文段中，ACK置1，确认号ack=y+1，序号seq=x+1
        *   该报文段可以携带数据，若不携带数据则不消耗序号
        *   TCP客户进程进入ESTABLISHED(已建立连接)状态
    *   完成此三步之后，就建立了TCP连接，提供全双工通信，双方的应用进程随时可以发送数据
*   服务器端的资源是在完成第二次握手时分配的，客户机端的资源是在完成第三次握手时分配的，这使服务器容易收到SYN洪泛攻击

![图片](/Users/coffeeboy/Desktop/考研/assets/d4a5f9892d1a9ac51671684e6383bc70311c4a.png)

*   TCP连接的释放，主要有四个步骤，称为**四次握手**
    *   第一步：客户机打算关闭连接时，向其TCP发送**连接释放报文段**，并停止发送数据，主动关闭TCP连接
        *   该报文段的终止位FIN置1，序号seq=u，等于前面已发送数据的最后一个字节序号加一
        *   FIN报文段即使不携带数据，也消耗一个序号
        *   TCP客户进程进入FIN-WAIT-1(终止等待1)状态
    *   第二步：服务器收到**连接释放报文段**后，发出确认
        *   确认号ack=u+1，序号seq=v，等于前面已传送过的数据的最后一个字节的序号加1
        *   服务器进入CLOSE-WAIT(关闭等待)状态
        *   此时，从客户机到服务器的连接就释放了，但是从服务器到客户机的连接还在，TCP连接处于半关闭状态
    *   第三步：若服务器已经没有要向客户机发送的数据，就通知TCP释放连接
        *   发出FIN=1的连接释放报文段，序号为w(在半关闭状态服务器可能又发送了数据)，再次发送ack=u+1
        *   服务器进入LAST-ACK(最后确认)状态
    *   第四步：客户机接收到**连接释放报文段**后，必须发出确认
        *   确认报文段中ACK置1，确认号ack=w+1，序号seq=u+1
        *   此时TCP连接还未释放，必须经过时间等待计时器设置的时间2MSL(最长报文段寿命)后，客户机进入CLOSED(连接关闭)状态

![图片](/Users/coffeeboy/Desktop/考研/assets/33a27f04976675a2e133051952435e0d4440a8-9518298.png)

*   对上述TCP连接的建立和释放总结：

    *   连接建立，分3步：

        1.SYN=1，seq=x

        2.SYN=1，ACK=1，ack=x+1，seq=y

        3.ACK=1，ack=y+1，seq=x+1

    *   释放连接，分4步：

        1.FIN=1，seq=u

        2.ACK=1，ack=u+1，seq=v

        3.FIN=1，ACK=1，ack=u+1，seq=w

        4.ACK=1，ack=w+1，seq=u+1



### TCP可靠传输

*   TCP提供的可靠数据传输服务保证接收方进程从缓存区读出的字节流与发送方发出的字节流完全一样
*   TCP使用**校验，序号，确认，重传**来达到可靠传输



#### 校验

*   TCP的校验和UDP的校验一样，不过将伪首部中的协议字段从17改为6，UDP长度改为TCP长度
*   采取反码求和再取反码的过程得到校验字段，接收方按反码求和，如果结果全为1则无错



#### 序号

*   TCP首部的序号字段用来保证数据能有序提交给应用层
*   TCP把数据视为一个无结构但有序的字节流，序号建立在传送的字节流之上
*   TCP连接传送的数据流中的每个字节都编上一个序号，而序号字段的值是指报文段所发送的数据的第一个字节的序号



#### 确认

*   TCP首部的确认号是期望收到对方的下一个报文段的数据的第一个字节的序号
*   发送方缓存区会继续存储那些已发送但未收到确认的报文段，以便在需要时重传
*   TCP默认使用累计确认，接收方的确认号字段始终是**序号最前面的还没收到的字节序号**，即使后面的字节已经收到



#### 重传

*   有两种事件会导致TCP对报文段进行重传：超时和冗余ACK
*   **超时：**
    *   TCP每发送一个报文段就对该报文段设置一个计时器，计时器设置的时间到期还没收到确认就重传
    *   TCP的下层是一个互联网环境，IP数据报所选择的路由变化很大，传输层的往返时延的方差也很大，为了计算超时计时器的重传时间，TCP采用一种**自适应算法：**
        *   记录一个报文段发出的时间，以及收到相应确认的时间，这两个时间之差称为**报文段的往返时延(RTT)**，TCP保留RTT的一个加权平均往返时间$RTT_S$，随新测量RTT样本值的变化而变化，所以，超时计时器的**超时重传时间(RTO)**应该略长于$RTT_s$
*   **冗余ACK(冗余确认)：**
    *   TCP默认使用累计确认，接收方的确认号字段始终是**序号最前面的还没收到的字节序号**，当后面的字节收到时就发送冗余ACK(即期待收到的那个序号)
    *   TCP规定当发送方收到对同一个报文段的3个冗余ACK时，就可以认为跟在这个被确认报文段之后的报文段已经丢失，立即对后一个报文段进行重传，这种技术通常称为**快速重传**



### TCP流量控制

*   TCP提供流量控制服务来**消除发送方时接收方缓存区溢出的可能性**，因此可以说流量控制是一个速度匹配服务

*   TCP提供一种基于滑动窗口协议的流量控制机制

*   与数据链路层的滑动窗口流量控制相比，TCP可以依靠**窗口字段**来动态调整窗口的大小

*   接收方根据自己接收缓存的大小，动态地调整发送方的发送窗口大小，这称为**接收窗口rwnd**

*   发送方根据对当前网络的拥塞程度的估计来确定窗口值，这称为**拥塞窗口cwnd**，其大小与网络的带宽和时延密切相关

*   发送方总是根据**最新**收到的rwnd值来限制自己发送窗口的大小，发送窗口的大小取**rwnd和cwnd的最小值**

    ![TCP流量控制_缓存](/Users/coffeeboy/Desktop/考研/assets/resize,m_fixed,w_1184-9522120-9522124.png)

*   传输层定义端到端用户之间的流量控制，数据链路层定义两个中间的相邻结点的流量控制

*   传输层的窗口大小可以动态变化，数据链路层的窗口大小不能变化



### TCP拥塞控制

*   拥塞控制是指防止过多的数据注入网络，保证网络中的路由器或链路不致过载
*   出现拥塞时，表现为通信时延的增加
*   拥塞控制和流量控制的区别：
    *   拥塞控制：让网络能够承受现有的网络负荷，是一个全局性的过程，涉及所有的主机，所有的路由器，以及与降低网络传输性能有关的所有因素
    *   流量控制：指点对点的通信量的控制，是个端到端的问题，抑制发送端发送数据的速率，以便使接收端来得及接收
    *   它们都通过控制发送方发送数据的速率来达到控制效果
*   因特网建议标准定义了进行拥塞控制的四种算法：慢开始，拥塞避免，快重传，快恢复
*   主要是维护两个窗口：
    *   接收窗口rwnd：接收方根据目前接收缓存大小所许诺的最新窗口值，反映接收方的容量，由接收方根据其放在TCP报文的首部的窗口字段通知发送方
    *   发送窗口cwnd：发送方根据自己估算的网络拥塞程度而设置的窗口值，反映网络的当前容量，只要网络未出现拥塞就把窗口增大一点，以便把更多的分组发送出去，只要网络出现拥塞，就把窗口增大一点，以减少注入网络的分组数



**下面不考虑接收方的缓存空间，发送窗口大小只由网络的拥塞程度决定，这是拥塞窗口等同于发送窗口，实际中要综合考虑：**

#### 慢开始和拥塞避免

*   **慢开始：**
    *   TCP刚建立时，cwnd设置为1，即一个最大报文段长度MSS
    *   之后每收到一个对新报文段的确认后，就将cwnd加1，即cwnd的值随传输轮次**指数规律增长**
    *   当cwnd大于一个规定的**慢开始门限ssthresh(阈值)**时，改用拥塞避免算法
*   **拥塞避免：**
    *   每经过一个往返时延RTT就把cwnd加1，使拥塞窗口cwnd按线性规律缓慢增长
    *   无论在哪个阶段，只要发送方判断网络出现拥塞(超时未收到确认)，就把**慢开始门限ssthresh**设置为出现拥塞时的cwnd的一半(但不能少于2)，当前cwnd设置为1，执行慢开始算法
        *   目的是：迅速减少主机发送到网络中的分组数，使得发生拥塞的路由器有足够时间把队列中积压的分组处理完
    *   如果在慢开始阶段，2cwnd>ssthresh，那么下一个RTT后把cwnd设置为ssthresh
*   根据cwnd的大小执行不同的算法：
    *   当cwnd<ssthresh时，使用慢开始算法
    *   当cwnd>ssthresh时，使用拥塞避免算法
    *   当cwnd=ssthresh时，既可以使用慢开始算法，也可以使用拥塞避免算法(通常使用这个)

![img](/Users/coffeeboy/Desktop/考研/assets/v2-f01ddee3e4a6a0640153f34bb9db6cbb_1440w-9528667.webp)

*   **乘法减少：**指不论是在慢开始阶段还是在拥塞避免阶段，只要出现超时(即很可能出现了网络拥塞)，就把慢开始门限值ssthresh设置为当前cwnd的一半(并执行慢开始算法)，当网络频繁出现拥塞时，ssthresh值就下降得很快，以大大减少注入网络的分组数
*   **加法增大：**指执行拥塞避免算法后，在收到对所有报文段的确认后(即经过一个RTT)，就把拥塞窗口cwnd增加一个MSS大小，使拥塞窗口缓慢增大，以防止网络过早出现拥塞
*   拥塞避免并不能完全避免拥塞，拥塞避免是指在拥塞避免阶段把拥塞窗口控制为线性规律增长，使网络比较不容易出现拥塞
*   **慢开始的本质是：每收到一个对新报文段的确认就将cwnd加1，所以每经过一个传输轮次(RTT)后，看起来cwnd是在乘以2，实际上是 一个一个加的**
*   一个传输轮次(RTT)传送的数据是一个发送窗口的大小

#### 快重传和快恢复

*   快重传和快恢复是对慢开始和拥塞避免算法的改进
*   **快重传：**使用冗余ACK来检测丢包的发生，也用于网络拥塞的检测
    *   当发送方连续收到三个重复的ACK报文时，直接重传对方尚未收到的报文段，而不必等待那个报文段设置的重传计时器超时
*   **快恢复：**当发送方连续收到三个冗余ACK时，执行“乘法减小”算法，把慢开始门限ssthresh设置为此时发送方cwnd的一半，cwnd也设置为cwnd的一半，然后开始执行拥塞避免算法(加法增大)，使拥塞窗口线性增大
    *   跳过了拥塞窗口cwnd从1开始的慢开始过程，所以称为**快恢复**

![img](/Users/coffeeboy/Desktop/考研/assets/v2-71c881dd3ce05d691b4b7d937dab8a85_1440w-9530701.webp)



*   流量控制中，发送方发送数据的量由接收方决定，拥塞控制中，由发送方自己通过检测网络状况来决定
*   在TCP连接建立和网络出现超时时，采用慢开始和拥塞避免算法，当发送方接收到冗余ACK时，采用快重传和快恢复算法



### 习题

*   TCP中端口号80标识**Web服务器端的HTTP进程**，客户端访问Web服务器的HTTP进程的端口号由客户端的操作系统动态分配
*   UDP提供的是不可靠的传输服务，不需要对报文编号，因此不会有序列号字段，而TCP有
*   伪首部中17代表UDP，6代表TCP
*   接收窗口rwnd和拥塞窗口cwnd中存放的都是**发送端能够发送的最大字节数**，而拥塞控制中，拥塞窗口cwnd的初始值和增加的值都是以**最大报文段长度MSS**，比如MSS=2KB，那么cwnd的初始值就是2，发送窗口的上限取小的那个
*   TCP是面向字节的，对每个字节进行编号，但是对报文段进行确认，所以TCP采用的是对报文段的确认机制
*   参与TCP连接的两个进程中的任何一个都能提出释放连接的请求
*   发送窗口的大小为N，指发送端可以在没有收到确认的情况下连续发送N个字节
*   如果两个端口之间已经建立了连接，希望再建立一个连接：会建立失败，但是不影响前面已经建立连接的传输，因为一条连接是用套接字来表示的，只有唯一一条可能的连接
*   TCP中将失序的报文段暂存于接收缓存中，待所缺序号的报文段收齐后再上交到应用层的好处是：
    *   有可能避免发送方对已被接收方收到的失序报文段的重传，减少对网络带宽的消耗，但增加了接收方缓冲区的开销
*   最大吞吐量：一个RTT内将发送窗口中的字节全部发送出去所达到的速率
*   为了使具有相同编号的报文段不同时在网络中传输，必须保证当序列号循环回来重复使用时，具有相同序列的报文段已经从网络中消失，所以**最高数据率 = 序号最大值 * 报文段大小 / 报文段的寿命  **或者**最高数据率 = TCP中序列号字段最大值  / 报文段的寿命**
*   目的端口号为21代表是一条FTP连接
*   快速以太网数据帧的有效载荷的最小长度是46B，IP分组总长度小于该值的都需要进行填充
*   MSS的默认值为536B，在因特网上的所有主机都能接收的报文段长度是536+20=556
*   四次握手中第四次为什么要等待2MSL(最长报文段寿命)再进入CLOSED状态：
    *   保证A发送的最后一个确认报文段能够到达B，如果不进行等待而确认报文段丢失，那么B不能进入正常关闭状态，而A已经关闭不能重传
    *   防止出现“已失效的连接请求报文段”，防止最开始的连接请求在某个结点滞留过久导致重传一个连接请求正常传输释放后最开始的连接请求到达接收方导致接收方一直等待确认浪费资源
*   如何判定一个确认报文段是对原报文段的确认还是对重传报文段的确认：
    *   使用修正的Karn算法作为规则：在计算平均往返时间RTT时，只要报文段重传了，就不采用其往返时间样本，且报文段每重传一次，就把RTO(超时重传时间)增大一些
*   为什么不采用“两次握手”建立连接：
    *   防止两次握手情况下已失效的连接请求报文段突然又传送到服务器而产生错误
*   UDP没有确认和重传机制，RTT对UDP没有意义，而TCP需要根据RTT的值来设置超时计时器的超时时间
*   必须依靠TCP的“可靠交付”功能才能保证在目的主机的目的进程中接收到正确的报文



![传输层](/Users/coffeeboy/Desktop/考研/assets/传输层-9605068.png)
